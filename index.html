<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Pro | Gestione Magazzino</title>
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1c23">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Inventario Pro">
    <style>
        :root {
            --primary: #4361ee;
            --primary-hover: #3a56d4;
            --secondary: #7209b7;
            --accent: #4cc9f0;
            --success: #2ec4b6;
            --warning: #ff9f1c;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: rgba(0, 0, 0, 0.08);
            --sidebar-bg: #1a1c23;
            --card-bg: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            color: var(--dark);
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .app-header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            font-size: 1.75rem;
            color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
            padding: 0.6rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-text h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark);
            letter-spacing: -0.5px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            transition: var(--transition);
        }

        .sync-status.online {
            background: rgba(46, 196, 182, 0.1);
            color: var(--success);
        }

        .sync-status.offline {
            background: rgba(108, 117, 125, 0.1);
            color: var(--gray);
        }

        .sync-status.syncing {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .sync-status.error {
            background: rgba(230, 57, 70, 0.1);
            color: var(--danger);
        }

        .sync-status i {
            font-size: 0.9rem;
        }

        .logo-text p {
            font-size: 0.8rem;
            color: var(--gray);
            font-weight: 500;
        }

        .status-badge {
            background: #e6fffa;
            color: #2c7a7b;
            padding: 0.4rem 1rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            border: 1px solid #b2f5ea;
        }

        /* Body & Sidebar */
        .app-body {
            display: flex;
            flex: 1;
        }

        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            color: white;
            padding: 1.5rem 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.05);
        }

        .nav-tabs {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .nav-tab {
            background: transparent;
            border: none;
            color: #a0aec0;
            padding: 0.8rem 1rem;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border-radius: 10px;
        }

        .nav-tab i {
            width: 20px;
            text-align: center;
        }

        .nav-tab:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        .content-section-sidebar {
            padding: 0 1rem;
        }

        .sidebar-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #718096;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-stats {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .sidebar-stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-stat-icon {
            width: 32px;
            height: 32px;
            background: rgba(46, 196, 182, 0.2);
            color: var(--success);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .sidebar-stat-info {
            display: flex;
            flex-direction: column;
        }

        .sidebar-stat-value {
            font-size: 0.95rem;
            font-weight: 700;
        }

        .sidebar-stat-label {
            font-size: 0.7rem;
            color: #a0aec0;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content.active {
            display: block;
        }

        .section-header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .header-title h2 {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--dark);
            letter-spacing: -0.5px;
        }

        .header-title p {
            color: var(--gray);
            font-size: 0.95rem;
        }

        /* Components */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card-main {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.25rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .stat-card-main:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }

        .stat-icon-wrapper {
            width: 54px;
            height: 54px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .icon-blue {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .icon-green {
            background: rgba(46, 196, 182, 0.1);
            color: var(--success);
        }

        .icon-orange {
            background: rgba(255, 159, 28, 0.1);
            color: var(--warning);
        }

        .icon-red {
            background: rgba(230, 57, 70, 0.1);
            color: var(--danger);
        }

        .icon-purple {
            background: rgba(114, 9, 183, 0.1);
            color: var(--secondary);
        }

        .stat-details {
            display: flex;
            flex-direction: column;
        }

        .stat-main-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--dark);
            line-height: 1.2;
        }

        .stat-main-label {
            font-size: 0.85rem;
            color: var(--gray);
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.25rem;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            transition: var(--transition);
        }

        .btn i {
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: scale(1.02);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #24b0a3;
            transform: scale(1.02);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: white;
            color: var(--dark);
            border: 1px solid var(--border);
        }

        .btn-outline:hover {
            background: #f8f9fa;
            border-color: var(--gray);
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            border-radius: 8px;
        }

        /* Forms */
        .search-container {
            position: relative;
            max-width: 500px;
            width: 100%;
        }

        .search-input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 2.8rem;
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .form-input,
        .form-select {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
        }

        /* Tables */
        .table-responsive {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 1rem 1.5rem;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray);
            background: #fafafa;
            border-bottom: 1px solid var(--border);
        }

        .data-table td {
            padding: 1rem 1.5rem;
            font-size: 0.95rem;
            border-bottom: 1px solid var(--border);
            color: var(--dark);
            vertical-align: middle;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: #fdfdfd;
        }

        .product-name-td {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
        }

        .product-icon-cell {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f2f5;
            color: var(--primary);
        }

        .badge {
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            min-height: 32px;
        }

        .badge-success {
            background: #e6fffa;
            color: #23a094;
        }

        .badge-warning {
            background: #fffaf0;
            color: #dd6b20;
        }

        .badge-danger {
            background: #fff5f5;
            color: #c53030;
        }

        .badge-neutral {
            background: #f7fafc;
            color: #4a5568;
        }

        .actions-cell {
            display: flex;
            gap: 0.5rem;
        }

        .btn-action {
            width: 52px;
            height: 52px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border);
            background: white;
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray);
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .btn-action:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
            transform: scale(1.08);
        }

        .btn-delete:hover {
            border-color: var(--danger);
            color: var(--danger);
            background: rgba(230, 57, 70, 0.05);
        }

        /* Action buttons - ACTUAL class used in tables */
        .action-btn {
            width: 52px !important;
            height: 52px !important;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border);
            background: white;
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray);
            font-size: 1.3rem;
            flex-shrink: 0;
            margin: 0 4px;
        }

        .action-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
            transform: scale(1.08);
        }

        .action-btn.delete:hover {
            border-color: var(--danger);
            color: var(--danger);
            background: rgba(230, 57, 70, 0.05);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 650px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .modal-close {
            background: #f7fafc;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--gray);
            transition: var(--transition);
        }

        .modal-close:hover {
            background: #edf2f7;
            color: var(--dark);
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            padding: 1.25rem 2rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            background: #fafafa;
        }

        /* Notifications */
        .notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 2000;
            transform: translateY(150%);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-left: 6px solid var(--primary);
            max-width: 400px;
        }

        .notification.show {
            transform: translateY(0);
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        .notification-icon {
            font-size: 1.5rem;
        }

        .notification.success .notification-icon {
            color: var(--success);
        }

        .notification.error .notification-icon {
            color: var(--danger);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 700;
            font-size: 0.95rem;
        }

        .notification-message {
            color: var(--gray);
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Charts */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 1.5rem;
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .chart-wrapper {
            height: 320px;
            position: relative;
        }

        /* Department Filter Buttons */
        .department-selector {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .department-btn {
            padding: 0.75rem 1.5rem;
            min-height: 48px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .department-btn i {
            font-size: 1.1rem;
        }

        .department-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
            transform: translateY(-2px);
        }

        .department-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        /* Mobile Adjustments */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
                padding: 1.5rem 0.5rem;
                align-items: center;
            }

            .nav-tab span,
            .sidebar-title,
            .sidebar-stats {
                display: none;
            }

            .nav-tab {
                justify-content: center;
                padding: 1rem;
            }

            .logo-text {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .app-body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                flex-direction: row;
                height: auto;
                padding: 0.5rem;
                gap: 1rem;
                scrollbar-width: none;
                overflow-x: auto;
            }

            .nav-tabs {
                flex-direction: row;
            }

            .main-content {
                padding: 1rem;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .header-actions {
                width: 100%;
                display: flex;
                gap: 0.5rem;
            }

            .header-actions .btn {
                flex: 1;
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }
        }
    </style>

</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-boxes"></i></div>
                <div class="logo-text">
                    <h1>Inventario Pro</h1>
                    <p>Gestione magazzino avanzata</p>
                </div>
            </div>
            <div id="cloudStatus" class="sync-status offline">
                <i class="fas fa-cloud"></i>
                <span id="cloudStatusText">Locale</span>
            </div>
        </header>

        <div class="app-body">
            <aside class="sidebar">
                <nav class="nav-tabs">
                    <button class="nav-tab active" onclick="showTab('dashboard')"><i
                            class="fas fa-th-large"></i><span>Dashboard</span></button>
                    <button class="nav-tab" onclick="showTab('products')"><i
                            class="fas fa-box"></i><span>Prodotti</span></button>
                    <button class="nav-tab" onclick="showTab('categories')"><i
                            class="fas fa-tags"></i><span>Categorie</span></button>
                    <button class="nav-tab" onclick="showTab('suppliers')"><i
                            class="fas fa-truck-moving"></i><span>Fornitori</span></button>
                    <button class="nav-tab" onclick="showTab('reports')"><i
                            class="fas fa-chart-pie"></i><span>Report</span></button>
                    <button class="nav-tab" onclick="showTab('monthly-inventory')"><i
                            class="fas fa-clipboard-list"></i><span>Inventario Mensile</span></button>
                    <button class="nav-tab" onclick="showTab('settings')"><i
                            class="fas fa-sliders-h"></i><span>Impostazioni</span></button>
                </nav>

                <div class="content-section-sidebar" style="margin-top: auto;">
                    <h3 class="sidebar-title">Statistiche Rapide</h3>
                    <div class="sidebar-stats">
                        <div class="sidebar-stat-card">
                            <div class="sidebar-stat-icon"><i class="fas fa-cubes"></i></div>
                            <div class="sidebar-stat-info">
                                <span class="sidebar-stat-value" id="total-products">0</span>
                                <span class="sidebar-stat-label">Prodotti Totali</span>
                            </div>
                        </div>
                        <div class="sidebar-stat-card">
                            <div class="sidebar-stat-icon"
                                style="background: rgba(114, 9, 183, 0.2); color: var(--secondary);"><i
                                    class="fas fa-wallet"></i></div>
                            <div class="sidebar-stat-info">
                                <span class="sidebar-stat-value" id="total-value">‚Ç¨ 0</span>
                                <span class="sidebar-stat-label">Valore Totale</span>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="main-content">
                <!-- DASHBOARD TAB -->
                <div class="tab-content active" id="dashboard-tab">
                    <div class="section-header">
                        <div class="header-title">
                            <h2>Panoramica Magazzino</h2>
                            <p>Monitora lo stato del tuo inventario in tempo reale</p>
                        </div>
                        <div class="header-actions">
                            <button class="btn btn-outline" onclick="refreshData()"><i
                                    class="fas fa-sync-alt"></i>Aggiorna</button>
                            <button class="btn btn-primary" onclick="showAddProductModal()"><i
                                    class="fas fa-plus"></i>Nuovo Prodotto</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 2rem;">
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="searchInput" class="search-input"
                                placeholder="Cerca per nome, categoria o fornitore..." onkeyup="handleSearch()">
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card-main">
                            <div class="stat-icon-wrapper icon-blue"><i class="fas fa-box"></i></div>
                            <div class="stat-details">
                                <span class="stat-main-value" id="inStockCount">0</span>
                                <span class="stat-main-label">In Stock</span>
                            </div>
                        </div>
                        <div class="stat-card-main">
                            <div class="stat-icon-wrapper icon-orange"><i class="fas fa-exclamation-triangle"></i></div>
                            <div class="stat-details">
                                <span class="stat-main-value" id="lowStockCount">0</span>
                                <span class="stat-main-label">Sotto Soglia</span>
                            </div>
                        </div>
                        <div class="stat-card-main">
                            <div class="stat-icon-wrapper icon-red"><i class="fas fa-clock"></i></div>
                            <div class="stat-details">
                                <span class="stat-main-value" id="outOfStockCount">0</span>
                                <span class="stat-main-label">Esauriti</span>
                            </div>
                        </div>
                        <div class="stat-card-main">
                            <div class="stat-icon-wrapper icon-purple"><i class="fas fa-layer-group"></i></div>
                            <div class="stat-details">
                                <span class="stat-main-value" id="categoriesCount">0</span>
                                <span class="stat-main-label">Categorie</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="section-header" style="margin-bottom: 1.5rem;">
                            <h3><i class="fas fa-history"
                                    style="margin-right: 0.5rem; color: var(--primary);"></i>Ultimi Prodotti Aggiunti
                            </h3>
                            <div class="header-actions">
                                <button class="btn btn-outline btn-sm" onclick="exportToExcel()"><i
                                        class="fas fa-file-excel"></i>Esporta</button>
                                <button class="btn btn-success btn-sm" onclick="showImportModal()"><i
                                        class="fas fa-file-import"></i>Importa</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Prodotto</th>
                                        <th>Fornitore</th>
                                        <th>Categoria</th>
                                        <th>Quantit√†</th>
                                        <th>Valore Unitario</th>
                                        <th>Valore Totale</th>
                                        <th>Stato</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- PRODUCTS TAB -->
                <div class="tab-content" id="products-tab">
                    <div class="section-header">
                        <div class="header-title">
                            <h2>Gestione Prodotti</h2>
                            <p>Aggiungi, modifica o rimuovi articoli dal tuo inventario</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="sidebar-title" style="color: var(--dark); margin-bottom: 1.5rem;"><i
                                class="fas fa-plus-circle"
                                style="margin-right: 0.5rem; color: var(--primary);"></i>Nuovo Prodotto</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Nome Prodotto</label>
                                <input type="text" id="productName" class="form-input"
                                    placeholder="Esempio: Smartphone X1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Categoria</label>
                                <select id="productCategory" class="form-select"
                                    onchange="updateSubcategories('product')">
                                    <option value="">Seleziona categoria</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sottocategoria</label>
                                <select id="productSubcategory" class="form-select">
                                    <option value="">Seleziona sottocategoria</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quantit√†</label>
                                <input type="number" id="productQuantity" class="form-input" placeholder="0" min="0"
                                    step="0.001">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Unit√†</label>
                                <select id="productUnit" class="form-select">
                                    <option value="pezzi">Pezzi</option>
                                    <option value="kg">Kg</option>
                                    <option value="litri">Litri</option>
                                    <option value="metri">Metri</option>
                                    <option value="scatole">Scatole</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Prezzo Unitario</label>
                                <input type="number" id="productPrice" class="form-input" placeholder="0.00" min="0"
                                    step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fornitore</label>
                                <select id="productSupplier" class="form-select">
                                    <option value="">Seleziona fornitore</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end;">
                            <button class="btn btn-primary" onclick="addProductFromForm()"><i
                                    class="fas fa-save"></i>Salva Prodotto</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="section-header" style="margin-bottom: 1.5rem;">
                            <h3><i class="fas fa-boxes"
                                    style="margin-right: 0.5rem; color: var(--primary);"></i>Catalogo Completo</h3>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="productSearchInput" class="form-input"
                                placeholder="üîç Cerca prodotto per nome, categoria o fornitore..."
                                onkeyup="filterProductsTable()" style="font-size: 1rem; padding: 0.75rem 1rem;">
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Prodotto</th>
                                        <th>Fornitore</th>
                                        <th>Categoria</th>
                                        <th>Sottocategoria</th>
                                        <th>Giacenza</th>
                                        <th>Prezzo</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="allProductsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- CATEGORIES TAB -->
                <div class="tab-content" id="categories-tab">
                    <div class="section-header">
                        <div class="header-title">
                            <h2>Gestione Categorie</h2>
                            <p>Organizza i tuoi prodotti per una ricerca pi√π rapida</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="sidebar-title" style="color: var(--dark); margin-bottom: 1.5rem;"><i
                                class="fas fa-folder-plus"
                                style="margin-right: 0.5rem; color: var(--primary);"></i>Nuova Categoria</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Nome Categoria</label>
                                <input type="text" id="categoryName" class="form-input"
                                    placeholder="Esempio: Ferramenta">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sottocategoria Iniziale</label>
                                <input type="text" id="subcategoryName" class="form-input"
                                    placeholder="Esempio: Viteria">
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end;">
                            <button class="btn btn-primary" onclick="addCategoryFromForm()"><i
                                    class="fas fa-save"></i>Salva Categoria</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="section-header" style="margin-bottom: 1.5rem;">
                            <h3><i class="fas fa-stream" style="margin-right: 0.5rem; color: var(--primary);"></i>Elenco
                                Categorie</h3>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Categoria</th>
                                        <th>Numero Prodotti</th>
                                        <th>Valore Totale</th>
                                        <th>Sottocategorie</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="categoriesTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SUPPLIERS TAB -->
                <div class="tab-content" id="suppliers-tab">
                    <div class="section-header">
                        <div class="header-title">
                            <h2>Gestione Fornitori</h2>
                            <p>Mantieni aggiornati i contatti dei tuoi partner commerciali</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="sidebar-title" style="color: var(--dark); margin-bottom: 1.5rem;"><i
                                class="fas fa-shipping-fast"
                                style="margin-right: 0.5rem; color: var(--primary);"></i>Anagrafica Fornitore</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Nome Fornitore</label>
                                <input type="text" id="supplierName" class="form-input" placeholder="Ragione Sociale">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Telefono</label>
                                <input type="text" id="supplierPhone" class="form-input" placeholder="+39 ...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" id="supplierEmail" class="form-input"
                                    placeholder="info@fornitore.it">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Indirizzo</label>
                                <input type="text" id="supplierAddress" class="form-input"
                                    placeholder="Via, Citt√†, CAP">
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end;">
                            <button class="btn btn-primary" onclick="addSupplierFromForm()"><i
                                    class="fas fa-save"></i>Salva Fornitore</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="section-header" style="margin-bottom: 1.5rem;">
                            <h3><i class="fas fa-address-book"
                                    style="margin-right: 0.5rem; color: var(--primary);"></i>Rubrica Fornitori</h3>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Fornitore</th>
                                        <th>Contatti</th>
                                        <th>Email</th>
                                        <th>Articoli</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="suppliersTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- REPORTS TAB -->
                <div class="tab-content" id="reports-tab">
                    <div class="section-header">
                        <div class="header-title">
                            <h2>Analisi e Reportistica</h2>
                            <p>Visualizza l'andamento del tuo magazzino e genera documenti PDF</p>
                        </div>
                        <div class="header-actions">
                            <button class="btn btn-outline" onclick="generateStockReport()"><i
                                    class="fas fa-file-pdf"></i>Stock PDF</button>
                            <button class="btn btn-outline" onclick="generateValueReport()"><i
                                    class="fas fa-file-invoice-dollar"></i>Valore PDF</button>
                        </div>
                    </div>

                    <div class="charts-container">
                        <div class="chart-card">
                            <h3 class="sidebar-title" style="color: var(--dark); margin-bottom: 1.5rem;"><i
                                    class="fas fa-chart-pie"
                                    style="margin-right: 0.5rem; color: var(--primary);"></i>Distribuzione per Categoria
                            </h3>
                            <div class="chart-wrapper">
                                <canvas id="categoryChartCanvas"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3 class="sidebar-title" style="color: var(--dark); margin-bottom: 1.5rem;"><i
                                    class="fas fa-chart-bar"
                                    style="margin-right: 0.5rem; color: var(--success);"></i>Stato Giacenze</h3>
                            <div class="chart-wrapper">
                                <canvas id="stockChartCanvas"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="stats-grid" style="margin-top: 2rem;">
                        <div class="report-card" onclick="showCategoryReport()">
                            <i class="fas fa-layer-group"></i>
                            <h3>Report Categorie</h3>
                            <p>Dettaglio prodotti per ogni categoria</p>
                        </div>
                        <div class="report-card" onclick="showSupplierReport()">
                            <i class="fas fa-address-book"></i>
                            <h3>Report Fornitori</h3>
                            <p>Analisi delle forniture e contatti</p>
                        </div>
                        <div class="report-card" onclick="showStockReport()">
                            <i class="fas fa-boxes"></i>
                            <h3>Esaurimenti</h3>
                            <p>Elenco articoli esauriti o in esaurimento</p>
                        </div>
                        <div class="report-card" onclick="showValueReport()">
                            <i class="fas fa-coins"></i>
                            <h3>Valutazione</h3>
                            <p>Stima economica totale dell'inventario</p>
                        </div>
                    </div>
                </div>

                <!-- MONTHLY INVENTORY TAB -->
                <div class="tab-content" id="monthly-inventory-tab">
                    <div class="section-header">
                        <div class="header-title">
                            <h2>Inventario Mensile</h2>
                            <p>Aggiorna rapidamente le quantit√† per l'inventario del mese</p>
                        </div>
                        <div class="header-actions">
                            <button class="btn btn-outline" onclick="exportMonthlyToExcel()"><i
                                    class="fas fa-file-excel"></i>Esporta Excel</button>
                            <button class="btn btn-success" onclick="createMonthlySnapshot()"><i
                                    class="fas fa-camera"></i>Salva Snapshot</button>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="stats-grid" style="margin-bottom: 0;">
                            <div class="stat-card-main">
                                <div class="stat-icon-wrapper icon-blue"><i class="fas fa-clipboard-check"></i></div>
                                <div class="stat-details">
                                    <span class="stat-main-value" id="monthlyCountedProducts">0</span>
                                    <span class="stat-main-label">Prodotti Verificati</span>
                                </div>
                            </div>
                            <div class="stat-card-main">
                                <div class="stat-icon-wrapper icon-orange"><i class="fas fa-hourglass-half"></i></div>
                                <div class="stat-details">
                                    <span class="stat-main-value" id="monthlyRemainingProducts">0</span>
                                    <span class="stat-main-label">Da Verificare</span>
                                </div>
                            </div>
                            <div class="stat-card-main">
                                <div class="stat-icon-wrapper icon-purple"><i class="fas fa-calendar-alt"></i></div>
                                <div class="stat-details">
                                    <span class="stat-main-value" id="lastSnapshotDate">Mai</span>
                                    <span class="stat-main-label">Ultimo Snapshot</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <!-- Department Selector -->
                        <div class="department-selector">
                            <span style="font-weight: 600; color: var(--gray); margin-right: 0.5rem;">Filtra
                                Reparto:</span>
                            <button class="department-btn active" onclick="setDepartmentFilter('tutti')"
                                id="dept-btn-tutti">
                                <i class="fas fa-layer-group"></i> Tutti
                            </button>
                            <button class="department-btn" onclick="setDepartmentFilter('cucina')" id="dept-btn-cucina">
                                <i class="fas fa-utensils"></i> Cucina
                            </button>
                            <button class="department-btn" onclick="setDepartmentFilter('bar')" id="dept-btn-bar">
                                <i class="fas fa-glass-martini-alt"></i> Bar
                            </button>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <div class="search-container">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" id="monthlySearchInput" class="search-input"
                                    placeholder="Cerca prodotto per nome, categoria o fornitore..."
                                    onkeyup="filterMonthlyInventory()">
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Prodotto</th>
                                        <th>Reparto</th>
                                        <th>Categoria</th>
                                        <th>Fornitore</th>
                                        <th>Quantit√† Attuale</th>
                                        <th>Nuova Quantit√†</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlyInventoryTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card"
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-info-circle"></i>
                            Gestione Inventario Mensile
                        </h3>
                        <p style="margin-bottom: 1rem; opacity: 0.95;">
                            Usa questa sezione per aggiornare rapidamente le quantit√† durante l'inventario mensile.
                            Le modifiche vengono salvate automaticamente.
                        </p>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button class="btn" style="background: white; color: #667eea;"
                                onclick="showSnapshotsModal()">
                                <i class="fas fa-history"></i>Storico Snapshot
                            </button>
                            <button class="btn btn-danger" onclick="showResetQuantitiesModal()">
                                <i class="fas fa-redo"></i>Reset Quantit√† (Nuovo Mese)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- SETTINGS TAB -->
                <div class="tab-content" id="settings-tab">
                    <div class="section-header">
                        <div class="header-title">
                            <h2>Impostazioni Sistema</h2>
                            <p>Configura le preferenze del software e la sincronizzazione cloud</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="sidebar-title" style="color: var(--dark); margin-bottom: 1.5rem;"><i
                                class="fas fa-cloud-sync"
                                style="margin-right: 0.5rem; color: var(--primary);"></i>Sincronizzazione Google Sheets
                        </h3>
                        <div class="form-group">
                            <label class="form-label">URL Web App Google Script</label>
                            <input type="text" id="googleScriptUrl" class="form-input"
                                placeholder="https://script.google.com/macros/s/.../exec" oninput="saveSettings()">
                            <p style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;">
                                Incolla qui l'URL ottenuto dopo aver pubblicato lo script su Google Apps Script.
                            </p>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label">
                                <input type="checkbox" id="autoSyncEnabled" onchange="toggleAutoSync()"
                                    style="margin-right: 0.5rem;">
                                Sincronizzazione Automatica
                            </label>
                            <p style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;">
                                Quando attiva, i dati vengono inviati automaticamente a Google Sheets dopo ogni
                                modifica.
                            </p>
                        </div>
                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="syncToGoogle()"><i
                                    class="fas fa-cloud-upload-alt"></i>Invia a Google</button>
                            <button class="btn btn-outline" onclick="restoreFromGoogle()"><i
                                    class="fas fa-cloud-download-alt"></i>Ripristina da Google</button>
                            <button class="btn btn-outline" onclick="generateQRCode()"><i
                                    class="fas fa-qrcode"></i>Genera QR Code</button>
                            <button class="btn btn-success" onclick="saveSettings()" style="margin-left: auto;"><i
                                    class="fas fa-save"></i>Salva Impostazioni</button>
                        </div>
                        <div id="qrCodeContainer"
                            style="display: none; margin-top: 1.5rem; text-align: center; padding: 1.5rem; background: #f8f9fa; border-radius: 12px;">
                            <h4 style="margin-bottom: 1rem;">Scansiona con il tuo dispositivo mobile</h4>
                            <div id="qrCodeImage"></div>
                            <p style="font-size: 0.85rem; color: var(--gray); margin-top: 1rem;">
                                Apri l'app sul dispositivo mobile e incolla l'URL nelle impostazioni
                            </p>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="card">
                            <h3 class="sidebar-title" style="color: var(--dark); margin-bottom: 1.5rem;"><i
                                    class="fas fa-bell"
                                    style="margin-right: 0.5rem; color: var(--warning);"></i>Preferenze Notifiche</h3>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label class="form-label">Notifiche Stock Basso</label>
                                <select id="lowStockNotifications" class="form-select">
                                    <option value="all">Tutte le notifiche</option>
                                    <option value="email">Solo email</option>
                                    <option value="none">Nessuna</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Soglia Stock Basso</label>
                                <input type="number" id="lowStockThreshold" class="form-input" value="5" min="1">
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="sidebar-title" style="color: var(--dark); margin-bottom: 1.5rem;"><i
                                    class="fas fa-globe"
                                    style="margin-right: 0.5rem; color: var(--accent);"></i>Localizzazione</h3>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label class="form-label">Lingua</label>
                                <select id="language" class="form-select">
                                    <option value="it">Italiano</option>
                                    <option value="en">English</option>
                                    <option value="fr">Fran√ßais</option>
                                    <option value="de">Deutsch</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Valuta</label>
                                <select id="currency" class="form-select">
                                    <option value="EUR">Euro (‚Ç¨)</option>
                                    <option value="USD">Dollaro ($)</option>
                                    <option value="GBP">Sterlina (¬£)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="sidebar-title" style="color: var(--dark); margin-bottom: 1.5rem;"><i
                                class="fas fa-database"
                                style="margin-right: 0.5rem; color: var(--gray);"></i>Manutenzione Dati</h3>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-outline" onclick="exportBackup()"><i
                                    class="fas fa-download"></i>Backup Locale</button>
                            <button class="btn btn-outline" onclick="showImportBackupModal()"><i
                                    class="fas fa-upload"></i>Ripristina Backup</button>
                            <button class="btn btn-danger" onclick="resetData()" style="margin-left: auto;"><i
                                    class="fas fa-trash-alt"></i>Reset Totale</button>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
                        <button class="btn btn-success btn-lg" style="padding: 0.8rem 2rem;" onclick="saveSettings()"><i
                                class="fas fa-check-circle"></i>Salva Tutte le Impostazioni</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal" id="addProductModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-plus-circle" style="color: var(--primary);"></i>Nuovo Prodotto
                </div>
                <button class="modal-close" onclick="closeAddProductModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Nome Prodotto</label>
                        <input type="text" id="modalProductName" class="form-input"
                            placeholder="Inserisci nome prodotto">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categoria</label>
                        <select id="modalProductCategory" class="form-select" onchange="updateSubcategories('modal')">
                            <option value="">Seleziona categoria</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reparto</label>
                        <select id="modalProductDepartment" class="form-select">
                            <option value="entrambi">üè¢ Entrambi</option>
                            <option value="cucina">üç≥ Cucina</option>
                            <option value="bar">üçπ Bar</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sottocategoria</label>
                        <select id="modalProductSubcategory" class="form-select">
                            <option value="">Seleziona sottocategoria</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantit√†</label>
                        <input type="number" id="modalProductQuantity" class="form-input" placeholder="0" min="0"
                            step="0.001">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unit√†</label>
                        <select id="modalProductUnit" class="form-select">
                            <option value="pezzi">Pezzi</option>
                            <option value="kg">Kg</option>
                            <option value="litri">Litri</option>
                            <option value="metri">Metri</option>
                            <option value="scatole">Scatole</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prezzo Unitario</label>
                        <input type="number" id="modalProductPrice" class="form-input" placeholder="0.00" min="0"
                            step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fornitore</label>
                        <select id="modalProductSupplier" class="form-select">
                            <option value="">Seleziona fornitore</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeAddProductModal()">Annulla</button>
                <button class="btn btn-primary" onclick="saveProduct()">Salva Prodotto</button>
            </div>
        </div>
    </div>

    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-file-import" style="color: var(--success);"></i>Importa da
                    Excel</div>
                <button class="modal-close" onclick="closeImportModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Seleziona file Excel (.xlsx, .xls)</label>
                    <input type="file" id="excelFile" class="form-input" accept=".xlsx, .xls">
                </div>
                <div id="importPreview" style="display: none; margin-top: 1.5rem;">
                    <h4 class="sidebar-title" style="color: var(--dark); margin-bottom: 1rem;">Anteprima Importazione
                    </h4>
                    <div class="table-responsive" style="max-height: 300px;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Categoria</th>
                                    <th>Sottocategoria</th>
                                    <th>Prodotto</th>
                                    <th>Quantit√†</th>
                                    <th>Unit√†</th>
                                    <th>Fornitore</th>
                                    <th>Prezzo</th>
                                    <th>Reparto</th>
                                </tr>
                            </thead>
                            <tbody id="importPreviewBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeImportModal()">Annulla</button>
                <button class="btn btn-success" onclick="processExcelImport()"><i class="fas fa-upload"></i>Importa
                    Ora</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addCategoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-folder-plus" style="color: var(--primary);"></i>Nuova
                    Categoria</div>
                <button class="modal-close" onclick="closeAddCategoryModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Nome Categoria</label>
                        <input type="text" id="modalCategoryName" class="form-input"
                            placeholder="Inserisci nome categoria">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sottocategoria</label>
                        <input type="text" id="modalSubcategoryName" class="form-input"
                            placeholder="Inserisci sottocategoria">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeAddCategoryModal()">Annulla</button>
                <button class="btn btn-primary" onclick="saveCategory()">Salva Categoria</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addSupplierModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-id-card" style="color: var(--primary);"></i>Nuovo Fornitore
                </div>
                <button class="modal-close" onclick="closeAddSupplierModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Nome Fornitore</label>
                        <input type="text" id="modalSupplierName" class="form-input"
                            placeholder="Inserisci nome fornitore">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefono</label>
                        <input type="text" id="modalSupplierPhone" class="form-input" placeholder="Inserisci telefono">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="modalSupplierEmail" class="form-input" placeholder="Inserisci email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Indirizzo</label>
                        <input type="text" id="modalSupplierAddress" class="form-input"
                            placeholder="Inserisci indirizzo">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeAddSupplierModal()">Annulla</button>
                <button class="btn btn-primary" onclick="saveSupplier()">Salva Fornitore</button>
            </div>
        </div>
    </div>

    <div class="modal" id="importBackupModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-database" style="color: var(--warning);"></i>Ripristina Backup
                    Locale</div>
                <button class="modal-close" onclick="closeImportBackupModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Seleziona file di backup (.json)</label>
                    <input type="file" id="backupFile" class="form-input" accept=".json">
                </div>
                <div
                    style="margin-top: 1rem; padding: 1rem; background: #fff5f5; border-radius: 10px; border: 1px solid #feb2b2; display: flex; gap: 0.75rem; align-items: flex-start;">
                    <i class="fas fa-exclamation-triangle" style="color: var(--danger); margin-top: 2px;"></i>
                    <p style="font-size: 0.85rem; color: #c53030; font-weight: 500;">
                        Attenzione: Il ripristino sovrascriver√† tutti i dati attualmente presenti nel browser. Questa
                        operazione non √® reversibile.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeImportBackupModal()">Annulla</button>
                <button class="btn btn-danger" onclick="restoreBackup()"><i class="fas fa-upload"></i>Sovrascrivi e
                    Ripristina</button>
            </div>
        </div>
    </div>

    <!-- SNAPSHOTS HISTORY MODAL -->
    <div class="modal" id="snapshotsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-history" style="color: var(--primary);"></i>Storico Snapshot
                    Inventario</div>
                <button class="modal-close" onclick="closeSnapshotsModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p style="color: var(--gray); margin-bottom: 1rem;">
                    Gli snapshot salvano lo stato dell'inventario in un momento specifico. Puoi esportarli o
                    ripristinarli.
                </p>
                <div id="snapshotsListContainer">
                    <p style="text-align: center; color: var(--gray); padding: 2rem;">
                        <i class="fas fa-inbox"
                            style="font-size: 3rem; opacity: 0.3; display: block; margin-bottom: 1rem;"></i>
                        Nessuno snapshot salvato
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeSnapshotsModal()">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- RESET QUANTITIES MODAL -->
    <div class="modal" id="resetQuantitiesModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i>Reset
                    Quantit√† - Nuovo Mese</div>
                <button class="modal-close" onclick="closeResetQuantitiesModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div
                    style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #856404; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-info-circle"></i>
                        Attenzione
                    </h4>
                    <p style="color: #856404; margin: 0; font-size: 0.9rem;">
                        Questa operazione azzerer√† <strong>SOLO le quantit√†</strong> di tutti i prodotti.
                        Tutti i prodotti, categorie, fornitori e prezzi rimarranno invariati.
                    </p>
                </div>

                <div
                    style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #0c5460; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-camera"></i>
                        Snapshot Automatico
                    </h4>
                    <p style="color: #0c5460; margin: 0; font-size: 0.9rem;">
                        Prima del reset verr√† creato automaticamente uno snapshot dell'inventario corrente
                        con la data di oggi.
                    </p>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="confirmResetCheckbox" style="margin-right: 0.5rem;">
                        Confermo di voler azzerare tutte le quantit√†
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeResetQuantitiesModal()">Annulla</button>
                <button class="btn btn-danger" onclick="confirmResetQuantities()" id="confirmResetBtn" disabled>
                    <i class="fas fa-redo"></i>Reset Quantit√†
                </button>
            </div>
        </div>
    </div>

    <!-- QUICK QUANTITY UPDATE MODAL -->
    <div class="modal" id="quickQuantityModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-edit" style="color: var(--primary);"></i>Aggiorna Quantit√†
                </div>
                <button class="modal-close" onclick="closeQuickQuantityModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">Prodotto</label>
                    <input type="text" id="quickProductName" class="form-input" readonly
                        style="background: #f8f9fa; cursor: not-allowed;">
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">Quantit√† Attuale</label>
                    <input type="text" id="quickCurrentQuantity" class="form-input" readonly
                        style="background: #f8f9fa; cursor: not-allowed;">
                </div>
                <div class="form-group">
                    <label class="form-label">Nuova Quantit√†</label>
                    <input type="number" id="quickNewQuantity" class="form-input" placeholder="Inserisci nuova quantit√†"
                        min="0" step="0.001" style="font-size: 1.2rem; font-weight: 600; color: var(--primary);">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeQuickQuantityModal()">Annulla</button>
                <button class="btn btn-success" onclick="saveQuickQuantity()"><i class="fas fa-check"></i>Salva</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <i class="fas fa-check-circle notification-icon"></i>
        <div class="notification-content">
            <div class="notification-title" id="notificationTitle">Successo</div>
            <div class="notification-message" id="notificationMessage">Operazione completata</div>
        </div>
    </div>

    <script>
        // DATI
        let appData = {
            products: [
                { id: 1, name: "iPhone 14 Pro", category: "Elettronica", subcategory: "Smartphone", quantity: 15, unit: "pezzi", price: 1199, supplier: "Apple Store", status: "in-stock" },
                { id: 2, name: "MacBook Air M2", category: "Elettronica", subcategory: "Computer", quantity: 8, unit: "pezzi", price: 1499, supplier: "Apple Store", status: "in-stock" },
                { id: 3, name: "Farina 00", category: "Alimentari", subcategory: "Farine", quantity: 3, unit: "kg", price: 1.5, supplier: "Fornitore Alimentari", status: "low-stock" },
                { id: 4, name: "Spaghetti", category: "Alimentari", subcategory: "Pasta", quantity: 0, unit: "kg", price: 1.2, supplier: "Fornitore Alimentari", status: "out-of-stock" }
            ],
            categories: [
                { id: 1, name: "Elettronica", productCount: 2, subcategories: ["Smartphone", "Computer", "Tablet"] },
                { id: 2, name: "Alimentari", productCount: 2, subcategories: ["Farine", "Pasta", "Conserve"] }
            ],
            suppliers: [
                { id: 1, name: "Apple Store", phone: "+39 02 1234567", email: "orders@apple.com", productCount: 2 },
                { id: 2, name: "Fornitore Alimentari", phone: "+39 055 123456", email: "info@alimentari.it", productCount: 2 }
            ],
            settings: { language: 'it', currency: 'EUR', decimalPlaces: 2, lowStockLimit: 5, stockNotifications: 'all', googleScriptUrl: 'https://script.google.com/macros/s/AKfycbz3DcZAXcFCX92DUWzZ7ToDOXQowrAseKwM11qcLW-gPwJ4wbW0PoDm8QEkK2_cTi_b/exec' },
            monthlySnapshots: [],
            monthlyInventoryChanges: {}
        };

        // INITIALIZATION
        window.onload = function () {
            // Load data from localStorage
            const savedData = localStorage.getItem('inventarioData');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    // Merge with default appData to ensure new settings fields exist
                    appData = {
                        ...appData,
                        ...parsedData,
                        settings: { ...appData.settings, ...parsedData.settings }
                    };
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            }

            // Set default view
            showTab('dashboard');

            // Add Global Event Listeners
            document.getElementById('searchInput').addEventListener('input', handleSearch);

            // Initial render
            updateAll();
        };

        // ... existing functions ...
        // TAB NAVIGATION
        function showTab(tabName) {
            // Update Active Tab Button
            document.querySelectorAll('.nav-tab').forEach(tab => {
                const isActive = tab.getAttribute('onclick').includes(tabName);
                tab.classList.toggle('active', isActive);
            });

            // Update Tab Content Visibility
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `${tabName}-tab`);
            });

            // Load Tab-Specific Data
            const tabLoaders = {
                'dashboard': loadDashboardData,
                'products': loadProductsTab,
                'categories': loadCategoriesTab,
                'suppliers': loadSuppliersTab,
                'reports': loadReportsTab,
                'monthly-inventory': loadMonthlyInventoryTab,
                'settings': loadSettingsTab
            };

            if (tabLoaders[tabName]) tabLoaders[tabName]();

            // On mobile, scroll to top when changing tabs
            if (window.innerWidth <= 768) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function loadDashboardData() {
            updateStatistics();
            renderRecentProducts();
        }

        function loadProductsTab() {
            populateCategoryDropdown('productCategory');
            populateSupplierDropdown('productSupplier');
            renderAllProductsTable();
        }

        function loadCategoriesTab() {
            renderCategoriesTable();
        }

        function loadSuppliersTab() {
            renderSuppliersTable();
        }

        function loadReportsTab() {
            // Give time for display: block to take effect before rendering charts
            setTimeout(renderCharts, 50);
        }

        function loadMonthlyInventoryTab() {
            renderMonthlyInventoryTable();
            updateMonthlyStats();
        }

        function loadSettingsTab() {
            const settings = appData.settings;
            const fields = {
                'lowStockNotifications': settings.stockNotifications,
                'lowStockThreshold': settings.lowStockLimit,
                'language': settings.language,
                'currency': settings.currency,
                'decimalPlaces': settings.decimalPlaces,
                'googleScriptUrl': settings.googleScriptUrl || ''
            };

            for (const [id, value] of Object.entries(fields)) {
                const el = document.getElementById(id);
                if (el) el.value = value;
            }

            // Carica stato auto-sync
            const autoSyncCheckbox = document.getElementById('autoSyncEnabled');
            if (autoSyncCheckbox) {
                autoSyncCheckbox.checked = settings.autoSync !== false;
            }
        }

        function populateCategoryDropdown(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            select.innerHTML = '<option value="">Seleziona categoria</option>';
            appData.categories.forEach(category => {
                select.innerHTML += `<option value="${category.id}">${category.name}</option>`;
            });
        }

        function populateSupplierDropdown(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            select.innerHTML = '<option value="">Seleziona fornitore</option>';
            appData.suppliers.forEach(supplier => {
                select.innerHTML += `<option value="${supplier.id}">${supplier.name}</option>`;
            });
        }

        // CORE RENDERING ENGINE
        function updateStatistics() {
            const stats = {
                totalProducts: appData.products.length,
                totalValue: appData.products.reduce((sum, p) => sum + (p.quantity * p.price), 0),
                inStock: appData.products.filter(p => p.quantity > appData.settings.lowStockLimit).length,
                lowStock: appData.products.filter(p => p.quantity > 0 && p.quantity <= appData.settings.lowStockLimit).length,
                outOfStock: appData.products.filter(p => p.quantity === 0).length,
                categories: appData.categories.length
            };

            const currency = appData.settings.currency === 'EUR' ? '‚Ç¨' : appData.settings.currency === 'USD' ? '$' : '¬£';

            // Sidebar Stats
            document.getElementById('total-products').textContent = stats.totalProducts;
            document.getElementById('total-value').textContent = `${currency} ${stats.totalValue.toLocaleString('it-IT', { minimumFractionDigits: 2 })}`;

            // Dashboard Stats
            document.getElementById('inStockCount').textContent = stats.inStock;
            document.getElementById('lowStockCount').textContent = stats.lowStock;
            document.getElementById('outOfStockCount').textContent = stats.outOfStock;
            document.getElementById('categoriesCount').textContent = stats.categories;
        }

        function renderRecentProducts() {
            const tbody = document.getElementById('productsTableBody');
            if (!tbody) return;

            // Get last 10 added/modified products
            const recent = [...appData.products].reverse().slice(0, 10);
            tbody.innerHTML = recent.map(p => createProductRow(p)).join('');
        }

        function renderAllProductsTable() {
            const tbody = document.getElementById('allProductsTableBody');
            if (!tbody) return;

            tbody.innerHTML = appData.products.map(p => {
                const currency = appData.settings.currency === 'EUR' ? '‚Ç¨' : '$';
                return `
                <tr class="fade-in">
                    <td class="product-cell">
                        <span class="product-name" style="font-weight: 600; color: var(--dark);">${p.name}</span>
                    </td>
                    <td><span class="product-meta">${p.supplier || 'Nessun fornitore'}</span></td>
                    <td><span class="badge badge-category">${p.category}</span></td>
                    <td><span class="subcategory-text">${p.subcategory || '-'}</span></td>
                    <td class="quantity-cell">
                        <span class="quantity-value">${p.quantity}</span>
                        <span class="quantity-unit">${p.unit}</span>
                    </td>
                    <td class="price-cell">${currency} ${p.price.toFixed(2)}</td>
                    <td>
                        <div class="table-actions">
                            <button class="action-btn" onclick="openQuickQuantityModal(${p.id})" title="Aggiorna Quantit√†" style="background: rgba(76, 201, 240, 0.1); color: var(--accent);"><i class="fas fa-hashtag"></i></button>
                            <button class="action-btn edit" onclick="editProduct(${p.id})" title="Modifica"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete" onclick="deleteProduct(${p.id})" title="Elimina"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function createProductRow(p) {
            const totalValue = p.quantity * p.price;
            const currency = appData.settings.currency === 'EUR' ? '‚Ç¨' : '$';

            let statusClass = 'badge-success';
            let statusText = 'In Stock';
            let statusIcon = 'fa-check-circle';

            if (p.quantity === 0) {
                statusClass = 'badge-danger';
                statusText = 'Esaurito';
                statusIcon = 'fa-times-circle';
            } else if (p.quantity <= appData.settings.lowStockLimit) {
                statusClass = 'badge-warning';
                statusText = 'Stock Basso';
                statusIcon = 'fa-exclamation-triangle';
            }

            return `
            <tr class="fade-in">
                <td class="product-cell">
                    <span class="product-name" style="font-weight: 600; color: var(--dark);">${p.name}</span>
                </td>
                <td><span class="product-meta">${p.supplier || 'Nessun fornitore'}</span></td>
                <td><span class="badge badge-category">${p.category}</span></td>
                <td class="quantity-cell">
                    <span class="quantity-value">${p.quantity}</span>
                    <span class="quantity-unit">${p.unit}</span>
                </td>
                <td class="price-cell">${currency} ${p.price.toFixed(2)}</td>
                <td class="price-cell"><strong>${currency} ${totalValue.toFixed(2)}</strong></td>
                <td><span class="badge ${statusClass}"><i class="fas ${statusIcon}"></i>${statusText}</span></td>
                <td>
                    <div class="table-actions">
                        <button class="action-btn edit" onclick="editProduct(${p.id})" title="Modifica"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete" onclick="deleteProduct(${p.id})" title="Elimina"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </td>
            </tr>`;
        }

        // FUNZIONI PRODOTTI
        function showAddProductModal() {
            populateCategoryDropdown('modalProductCategory');
            populateSupplierDropdown('modalProductSupplier');
            document.getElementById('addProductModal').classList.add('show');
        }

        function closeAddProductModal() {
            document.getElementById('addProductModal').classList.remove('show');
        }

        function saveProduct() {
            const name = document.getElementById('modalProductName').value;
            const categoryId = document.getElementById('modalProductCategory').value;
            const subcategory = document.getElementById('modalProductSubcategory').value;
            const department = document.getElementById('modalProductDepartment').value;
            const quantity = parseFloat(document.getElementById('modalProductQuantity').value);
            const unit = document.getElementById('modalProductUnit').value;
            const price = parseFloat(document.getElementById('modalProductPrice').value);
            const supplierId = document.getElementById('modalProductSupplier').value;

            if (!name || !categoryId || isNaN(quantity) || isNaN(price)) {
                showNotification('Compila tutti i campi obbligatori', 'error');
                return;
            }

            const category = appData.categories.find(cat => cat.id == categoryId);
            const supplier = appData.suppliers.find(sup => sup.id == supplierId);

            const newProduct = {
                id: Date.now(),
                name: name,
                category: category.name,
                subcategory: subcategory,
                department: department || 'entrambi',
                quantity: quantity,
                unit: unit,
                price: price,
                supplier: supplier ? supplier.name : 'Default',
                status: quantity === 0 ? 'out-of-stock' : quantity <= appData.settings.lowStockLimit ? 'low-stock' : 'in-stock'
            };

            appData.products.push(newProduct);
            category.productCount++;
            if (supplier) supplier.productCount++;

            saveToCloud();
            closeAddProductModal();
            updateAll();
            showNotification('Prodotto aggiunto!');
        }

        function addProductFromForm() {
            const name = document.getElementById('productName').value;
            const categoryId = document.getElementById('productCategory').value;
            const subcategory = document.getElementById('productSubcategory').value;
            const quantity = parseFloat(document.getElementById('productQuantity').value);
            const unit = document.getElementById('productUnit').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const supplierId = document.getElementById('productSupplier').value;

            if (!name || !categoryId || isNaN(quantity) || isNaN(price)) {
                showNotification('Compila tutti i campi obbligatori', 'error');
                return;
            }

            const category = appData.categories.find(cat => cat.id == categoryId);
            const supplier = appData.suppliers.find(sup => sup.id == supplierId);

            const newProduct = {
                id: Date.now(),
                name: name,
                category: category.name,
                subcategory: subcategory,
                quantity: quantity,
                unit: unit,
                price: price,
                supplier: supplier ? supplier.name : 'Default',
                status: quantity === 0 ? 'out-of-stock' : quantity <= appData.settings.lowStockLimit ? 'low-stock' : 'in-stock'
            };

            appData.products.push(newProduct);
            category.productCount++;
            if (supplier) supplier.productCount++;

            // Reset form
            document.getElementById('productName').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productSubcategory').value = '';
            document.getElementById('productQuantity').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productSupplier').value = '';

            updateAll();
            showNotification('Prodotto aggiunto!');
        }

        function editProduct(productId) {
            const product = appData.products.find(p => p.id === productId);
            if (!product) return;

            showAddProductModal();

            // Popola i campi con i dati del prodotto
            document.getElementById('modalProductName').value = product.name;
            document.getElementById('modalProductDepartment').value = product.department || 'entrambi';

            const category = appData.categories.find(c => c.name === product.category);
            if (category) {
                document.getElementById('modalProductCategory').value = category.id;
                updateSubcategories('modal');

                // Imposta la sottocategoria dopo un breve ritardo per permettere il caricamento
                setTimeout(() => {
                    document.getElementById('modalProductSubcategory').value = product.subcategory;
                }, 100);
            }

            document.getElementById('modalProductQuantity').value = product.quantity;
            document.getElementById('modalProductUnit').value = product.unit;
            document.getElementById('modalProductPrice').value = product.price;

            const supplier = appData.suppliers.find(s => s.name === product.supplier);
            if (supplier) {
                document.getElementById('modalProductSupplier').value = supplier.id;
            }

            // Cambia il titolo del modal
            document.querySelector('#addProductModal .modal-title').innerHTML = '<i class="fas fa-edit"></i>Modifica Prodotto';

            // Cambia l'azione del pulsante Salva
            const saveButton = document.querySelector('#addProductModal .btn-success');
            saveButton.textContent = 'Aggiorna Prodotto';
            saveButton.onclick = function () { updateProduct(productId); };
        }

        function updateProduct(productId) {
            const name = document.getElementById('modalProductName').value;
            const categoryId = document.getElementById('modalProductCategory').value;
            const subcategory = document.getElementById('modalProductSubcategory').value;
            const department = document.getElementById('modalProductDepartment').value;
            const quantity = parseFloat(document.getElementById('modalProductQuantity').value);
            const unit = document.getElementById('modalProductUnit').value;
            const price = parseFloat(document.getElementById('modalProductPrice').value);
            const supplierId = document.getElementById('modalProductSupplier').value;

            if (!name || !categoryId || isNaN(quantity) || isNaN(price)) {
                showNotification('Compila tutti i campi obbligatori', 'error');
                return;
            }

            const productIndex = appData.products.findIndex(p => p.id === productId);
            if (productIndex === -1) return;

            const oldCategory = appData.categories.find(c => c.name === appData.products[productIndex].category);
            if (oldCategory) oldCategory.productCount--;

            const oldSupplier = appData.suppliers.find(s => s.name === appData.products[productIndex].supplier);
            if (oldSupplier) oldSupplier.productCount--;

            const category = appData.categories.find(cat => cat.id == categoryId);
            const supplier = appData.suppliers.find(sup => sup.id == supplierId);

            appData.products[productIndex] = {
                id: productId,
                name: name,
                category: category.name,
                subcategory: subcategory,
                department: department || 'entrambi',
                quantity: quantity,
                unit: unit,
                price: price,
                supplier: supplier ? supplier.name : 'Default',
                status: quantity === 0 ? 'out-of-stock' : quantity <= appData.settings.lowStockLimit ? 'low-stock' : 'in-stock'
            };

            category.productCount++;
            if (supplier) supplier.productCount++;

            saveToCloud();
            closeAddProductModal();
            updateAll();
            showNotification('Prodotto aggiornato!');
        }

        // QUICK QUANTITY UPDATE
        let currentQuickEditProductId = null;

        function openQuickQuantityModal(productId) {
            const product = appData.products.find(p => p.id === productId);
            if (!product) return;

            currentQuickEditProductId = productId;

            document.getElementById('quickProductName').value = product.name;
            document.getElementById('quickCurrentQuantity').value = `${product.quantity} ${product.unit}`;
            document.getElementById('quickNewQuantity').value = product.quantity;

            document.getElementById('quickQuantityModal').classList.add('show');

            // Focus on input
            setTimeout(() => {
                const input = document.getElementById('quickNewQuantity');
                input.focus();
                input.select();
            }, 100);
        }

        function closeQuickQuantityModal() {
            document.getElementById('quickQuantityModal').classList.remove('show');
            currentQuickEditProductId = null;
        }

        function saveQuickQuantity() {
            if (!currentQuickEditProductId) return;

            const newQuantity = parseFloat(document.getElementById('quickNewQuantity').value);

            if (isNaN(newQuantity) || newQuantity < 0) {
                showNotification('Inserisci una quantit√† valida', 'error');
                return;
            }

            const productIndex = appData.products.findIndex(p => p.id === currentQuickEditProductId);
            if (productIndex === -1) return;

            const oldQuantity = appData.products[productIndex].quantity;
            appData.products[productIndex].quantity = newQuantity;

            // Update status
            appData.products[productIndex].status =
                newQuantity === 0 ? 'out-of-stock' :
                    newQuantity <= appData.settings.lowStockLimit ? 'low-stock' : 'in-stock';

            closeQuickQuantityModal();
            updateAll();

            const productName = appData.products[productIndex].name;
            showNotification(`Quantit√† aggiornata: ${productName} (${oldQuantity} ‚Üí ${newQuantity})`, 'success');
        }

        // PRODUCT TABLE FILTER
        function filterProductsTable() {
            const searchTerm = document.getElementById('productSearchInput').value.toLowerCase();
            const tbody = document.getElementById('allProductsTableBody');
            if (!tbody) return;

            const filteredProducts = appData.products.filter(product =>
                product.name.toLowerCase().includes(searchTerm) ||
                product.category.toLowerCase().includes(searchTerm) ||
                product.subcategory.toLowerCase().includes(searchTerm) ||
                (product.supplier && product.supplier.toLowerCase().includes(searchTerm))
            );

            const currency = appData.settings.currency === 'EUR' ? '‚Ç¨' : '$';
            tbody.innerHTML = filteredProducts.map(p => {
                return `
                <tr class="fade-in">
                    <td class="product-cell">
                        <span class="product-name" style="font-weight: 600; color: var(--dark);">${p.name}</span>
                    </td>
                    <td><span class="product-meta">${p.supplier || 'Nessun fornitore'}</span></td>
                    <td><span class="badge badge-category">${p.category}</span></td>
                    <td><span class="subcategory-text">${p.subcategory || '-'}</span></td>
                    <td class="quantity-cell">
                        <span class="quantity-value">${p.quantity}</span>
                        <span class="quantity-unit">${p.unit}</span>
                    </td>
                    <td class="price-cell">${currency} ${p.price.toFixed(2)}</td>
                    <td>
                        <div class="table-actions">
                            <button class="action-btn" onclick="openQuickQuantityModal(${p.id})" title="Aggiorna Quantit√†" style="background: rgba(76, 201, 240, 0.1); color: var(--accent);"><i class="fas fa-hashtag"></i></button>
                            <button class="action-btn edit" onclick="editProduct(${p.id})" title="Modifica"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete" onclick="deleteProduct(${p.id})" title="Elimina"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function deleteProduct(productId) {
            if (confirm('Eliminare questo prodotto?')) {
                const index = appData.products.findIndex(p => p.id === productId);
                if (index !== -1) {
                    const product = appData.products[index];

                    // Aggiorna il conteggio nella categoria
                    const category = appData.categories.find(c => c.name === product.category);
                    if (category) category.productCount--;

                    // Aggiorna il conteggio nel fornitore
                    const supplier = appData.suppliers.find(s => s.name === product.supplier);
                    if (supplier) supplier.productCount--;

                    appData.products.splice(index, 1);
                    saveToCloud();
                    updateAll();
                    showNotification('Prodotto eliminato');
                }
            }
        }

        // CATEGORIES & SUPPLIERS RENDERING
        function renderCategoriesTable() {
            const tbody = document.getElementById('categoriesTableBody');
            if (!tbody) return;

            const currency = appData.settings.currency === 'EUR' ? '‚Ç¨' : '$';

            tbody.innerHTML = appData.categories.map(c => {
                const catProducts = appData.products.filter(p => p.category === c.name);
                const totalVal = catProducts.reduce((sum, p) => sum + (p.quantity * p.price), 0);

                return `
                <tr class="fade-in">
                    <td><strong>${c.name}</strong></td>
                    <td><span class="badge badge-unit">${catProducts.length} Prodotti</span></td>
                    <td><span class="badge badge-success">${currency} ${totalVal.toLocaleString('it-IT', { minimumFractionDigits: 2 })}</span></td>
                    <td>
                        <div class="d-flex flex-wrap gap-5">
                            ${c.subcategories.map(sub => `<span class="badge badge-unit">${sub}</span>`).join('')}
                        </div>
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="action-btn edit" onclick="editCategory(${c.id})" title="Modifica"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete" onclick="deleteCategory(${c.id})" title="Elimina"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderSuppliersTable() {
            const tbody = document.getElementById('suppliersTableBody');
            if (!tbody) return;

            tbody.innerHTML = appData.suppliers.map(s => `
                <tr class="fade-in">
                    <td>
                        <div class="supplier-info">
                            <span class="supplier-name">${s.name}</span>
                            <span class="supplier-address"><i class="fas fa-map-marker-alt"></i> ${s.address || '-'}</span>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex flex-column">
                            <span><i class="fas fa-phone"></i> ${s.phone || '-'}</span>
                        </div>
                    </td>
                    <td><a href="mailto:${s.email}" class="supplier-email"><i class="fas fa-envelope"></i> ${s.email || '-'}</a></td>
                    <td><span class="badge badge-unit">${s.productCount} Articoli</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="action-btn edit" onclick="editSupplier(${s.id})" title="Modifica"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete" onclick="deleteSupplier(${s.id})" title="Elimina"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // FUNZIONI CATEGORIE
        function showAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.add('show');
        }

        function closeAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.remove('show');
        }

        function saveCategory() {
            const name = document.getElementById('modalCategoryName').value;
            const subcategory = document.getElementById('modalSubcategoryName').value;

            if (!name) {
                showNotification('Inserisci un nome per la categoria', 'error');
                return;
            }

            const newCategory = {
                id: Date.now(),
                name: name,
                productCount: 0,
                subcategories: subcategory ? [subcategory] : []
            };

            appData.categories.push(newCategory);
            closeAddCategoryModal();
            updateAll();
            showNotification('Categoria aggiunta!');
        }

        function addCategoryFromForm() {
            const name = document.getElementById('categoryName').value;
            const subcategory = document.getElementById('subcategoryName').value;

            if (!name) {
                showNotification('Inserisci un nome per la categoria', 'error');
                return;
            }

            const newCategory = {
                id: Date.now(),
                name: name,
                productCount: 0,
                subcategories: subcategory ? [subcategory] : []
            };

            appData.categories.push(newCategory);

            // Reset form
            document.getElementById('categoryName').value = '';
            document.getElementById('subcategoryName').value = '';

            updateAll();
            showNotification('Categoria aggiunta!');
        }

        function editCategory(categoryId) {
            const category = appData.categories.find(c => c.id === categoryId);
            if (!category) return;

            showAddCategoryModal();

            // Popola i campi con i dati della categoria
            document.getElementById('modalCategoryName').value = category.name;

            // Cambia il titolo del modal
            document.querySelector('#addCategoryModal .modal-title').innerHTML = '<i class="fas fa-edit"></i>Modifica Categoria';

            // Cambia l'azione del pulsante Salva
            const saveButton = document.querySelector('#addCategoryModal .btn-success');
            saveButton.textContent = 'Aggiorna Categoria';
            saveButton.onclick = function () { updateCategory(categoryId); };
        }

        function updateCategory(categoryId) {
            const name = document.getElementById('modalCategoryName').value;

            if (!name) {
                showNotification('Inserisci un nome per la categoria', 'error');
                return;
            }

            const categoryIndex = appData.categories.findIndex(c => c.id === categoryId);
            if (categoryIndex === -1) return;

            // Aggiorna i prodotti che usano questa categoria
            const oldName = appData.categories[categoryIndex].name;
            appData.products.forEach(product => {
                if (product.category === oldName) {
                    product.category = name;
                }
            });

            appData.categories[categoryIndex].name = name;

            closeAddCategoryModal();
            updateAll();
            showNotification('Categoria aggiornata!');
        }

        function deleteCategory(categoryId) {
            if (confirm('Eliminare questa categoria? I prodotti associati verranno spostati in "Senza categoria".')) {
                const index = appData.categories.findIndex(c => c.id === categoryId);
                if (index !== -1) {
                    // Sposta i prodotti in una categoria predefinita
                    appData.products.forEach(product => {
                        if (product.category === appData.categories[index].name) {
                            product.category = "Senza categoria";
                        }
                    });

                    appData.categories.splice(index, 1);
                    saveToCloud();
                    updateAll();
                    showNotification('Categoria eliminata');
                }
            }
        }

        // FUNZIONI FORNITORI
        function showAddSupplierModal() {
            document.getElementById('addSupplierModal').classList.add('show');
        }

        function closeAddSupplierModal() {
            document.getElementById('addSupplierModal').classList.remove('show');
        }

        function saveSupplier() {
            const name = document.getElementById('modalSupplierName').value;
            const phone = document.getElementById('modalSupplierPhone').value;
            const email = document.getElementById('modalSupplierEmail').value;
            const address = document.getElementById('modalSupplierAddress').value;

            if (!name) {
                showNotification('Inserisci un nome per il fornitore', 'error');
                return;
            }

            const newSupplier = {
                id: Date.now(),
                name: name,
                phone: phone,
                email: email,
                address: address,
                productCount: 0
            };

            appData.suppliers.push(newSupplier);
            closeAddSupplierModal();
            updateAll();
            showNotification('Fornitore aggiunto!');
        }

        function addSupplierFromForm() {
            const name = document.getElementById('supplierName').value;
            const phone = document.getElementById('supplierPhone').value;
            const email = document.getElementById('supplierEmail').value;
            const address = document.getElementById('supplierAddress').value;

            if (!name) {
                showNotification('Inserisci un nome per il fornitore', 'error');
                return;
            }

            const newSupplier = {
                id: Date.now(),
                name: name,
                phone: phone,
                email: email,
                address: address,
                productCount: 0
            };

            appData.suppliers.push(newSupplier);

            // Reset form
            document.getElementById('supplierName').value = '';
            document.getElementById('supplierPhone').value = '';
            document.getElementById('supplierEmail').value = '';
            document.getElementById('supplierAddress').value = '';

            updateAll();
            showNotification('Fornitore aggiunto!');
        }

        function editSupplier(supplierId) {
            const supplier = appData.suppliers.find(s => s.id === supplierId);
            if (!supplier) return;

            showAddSupplierModal();

            // Popola i campi con i dati del fornitore
            document.getElementById('modalSupplierName').value = supplier.name;
            document.getElementById('modalSupplierPhone').value = supplier.phone;
            document.getElementById('modalSupplierEmail').value = supplier.email;
            document.getElementById('modalSupplierAddress').value = supplier.address;

            // Cambia il titolo del modal
            document.querySelector('#addSupplierModal .modal-title').innerHTML = '<i class="fas fa-edit"></i>Modifica Fornitore';

            // Cambia l'azione del pulsante Salva
            const saveButton = document.querySelector('#addSupplierModal .btn-success');
            saveButton.textContent = 'Aggiorna Fornitore';
            saveButton.onclick = function () { updateSupplier(supplierId); };
        }

        function updateSupplier(supplierId) {
            const name = document.getElementById('modalSupplierName').value;
            const phone = document.getElementById('modalSupplierPhone').value;
            const email = document.getElementById('modalSupplierEmail').value;
            const address = document.getElementById('modalSupplierAddress').value;

            if (!name) {
                showNotification('Inserisci un nome per il fornitore', 'error');
                return;
            }

            const supplierIndex = appData.suppliers.findIndex(s => s.id === supplierId);
            if (supplierIndex === -1) return;

            // Aggiorna i prodotti che usano questo fornitore
            const oldName = appData.suppliers[supplierIndex].name;
            appData.products.forEach(product => {
                if (product.supplier === oldName) {
                    product.supplier = name;
                }
            });

            appData.suppliers[supplierIndex] = {
                ...appData.suppliers[supplierIndex],
                name: name,
                phone: phone,
                email: email,
                address: address
            };

            closeAddSupplierModal();
            updateAll();
            showNotification('Fornitore aggiornato!');
        }

        function deleteSupplier(supplierId) {
            if (confirm('Eliminare questo fornitore? I prodotti associati verranno spostati in "Fornitore sconosciuto".')) {
                const index = appData.suppliers.findIndex(s => s.id === supplierId);
                if (index !== -1) {
                    // Sposta i prodotti in un fornitore predefinito
                    appData.products.forEach(product => {
                        if (product.supplier === appData.suppliers[index].name) {
                            product.supplier = "Fornitore sconosciuto";
                        }
                    });

                    appData.suppliers.splice(index, 1);
                    saveToCloud();
                    updateAll();
                    showNotification('Fornitore eliminato');
                }
            }
        }

        // FUNZIONI SOTTOCATEGORIE
        function updateSubcategories(type) {
            const categorySelect = type === 'modal' ?
                document.getElementById('modalProductCategory') :
                document.getElementById('productCategory');

            const subcategorySelect = type === 'modal' ?
                document.getElementById('modalProductSubcategory') :
                document.getElementById('productSubcategory');

            if (!categorySelect || !subcategorySelect) return;

            const categoryId = categorySelect.value;
            const category = appData.categories.find(c => c.id == categoryId);

            subcategorySelect.innerHTML = '<option value="">Seleziona sottocategoria</option>';

            if (category && category.subcategories) {
                category.subcategories.forEach(subcategory => {
                    subcategorySelect.innerHTML += `<option value="${subcategory}">${subcategory}</option>`;
                });
            }
        }

        // FUNZIONI REPORT
        function showCategoryReport() {
            if (!window.jspdf) {
                showNotification('Libreria PDF non caricata. Controlla la connessione internet.', 'error');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.text("Report per Categoria", 14, 22);
            doc.setFontSize(11);
            doc.text("Generato il: " + new Date().toLocaleString(), 14, 30);

            const tableColumn = ["Categoria", "Prodotti", "Quantit√† Totale", "Valore Totale"];
            const tableRows = [];

            const currency = appData.settings.currency === 'EUR' ? '‚Ç¨' : '$';

            appData.categories.forEach(cat => {
                const catProducts = appData.products.filter(p => p.category === cat.name);
                const totalQty = catProducts.reduce((sum, p) => sum + p.quantity, 0);
                const totalVal = catProducts.reduce((sum, p) => sum + (p.quantity * p.price), 0);

                tableRows.push([
                    cat.name,
                    catProducts.length,
                    totalQty.toFixed(2),
                    currency + " " + totalVal.toLocaleString('it-IT', { minimumFractionDigits: 2 })
                ]);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 40,
                theme: 'grid',
                headStyles: { fillColor: [114, 9, 183] }
            });

            doc.save("report_categorie.pdf");
            showNotification('Report Categorie scaricato!', 'success');
        }

        function showSupplierReport() {
            if (!window.jspdf) {
                showNotification('Libreria PDF non caricata. Controlla la connessione internet.', 'error');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.text("Report per Fornitore", 14, 22);
            doc.setFontSize(11);
            doc.text("Generato il: " + new Date().toLocaleString(), 14, 30);

            const tableColumn = ["Fornitore", "Prodotti", "Contatti", "Valore Fornitura"];
            const tableRows = [];

            appData.suppliers.forEach(sup => {
                const supProducts = appData.products.filter(p => p.supplier === sup.name);
                const totalVal = supProducts.reduce((sum, p) => sum + (p.quantity * p.price), 0);

                // Formatta i contatti
                let contactInfo = sup.email;
                if (sup.phone) contactInfo += (contactInfo ? " / " : "") + sup.phone;

                tableRows.push([
                    sup.name,
                    supProducts.length,
                    contactInfo || "-",
                    "‚Ç¨ " + totalVal.toFixed(2)
                ]);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 40,
                theme: 'grid',
                headStyles: { fillColor: [58, 12, 163] }
            });

            doc.save("report_fornitori.pdf");
            showNotification('Report Fornitori scaricato!', 'success');
        }

        function showStockReport() {
            showNotification('Report stock generato', 'success');
        }

        function showValueReport() {
            showNotification('Report valore generato', 'success');
        }

        function generateStockReport() {

            // Fix for jspdf undefined
            if (!window.jspdf) {
                showNotification('Libreria PDF non caricata. Controlla la connessione internet.', 'error');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.text("Report Stock Magazzino", 14, 22);
            doc.setFontSize(11);
            doc.text("Generato il: " + new Date().toLocaleString(), 14, 30);

            const tableColumn = ["Prodotto", "Categoria", "Qta", "Unita", "Stato"];
            const tableRows = [];

            appData.products.forEach(product => {
                const productData = [
                    product.name,
                    product.category,
                    product.quantity,
                    product.unit,
                    product.status === 'out-of-stock' ? 'Esaurito' : (product.status === 'low-stock' ? 'Basso' : 'Ok')
                ];
                tableRows.push(productData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 40,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [67, 97, 238] }
            });

            doc.save("report_stock.pdf");
            showNotification('PDF scaricato!', 'success');
        }

        function generateValueReport() {
            // Fix for jspdf undefined
            if (!window.jspdf) {
                showNotification('Libreria PDF non caricata. Controlla la connessione internet.', 'error');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.text("Report Valore Magazzino", 14, 22);
            doc.setFontSize(11);
            doc.text("Generato il: " + new Date().toLocaleString(), 14, 30);

            let totalValue = 0;
            const tableColumn = ["Prodotto", "Qta", "Prezzo", "Totale"];
            const tableRows = [];

            const currency = appData.settings.currency === 'EUR' ? '‚Ç¨' : '$';

            appData.products.forEach(product => {
                const rowTotal = product.quantity * product.price;
                totalValue += rowTotal;
                const productData = [
                    product.name,
                    product.quantity,
                    currency + " " + product.price.toFixed(2),
                    currency + " " + rowTotal.toFixed(2)
                ];
                tableRows.push(productData);
            });

            // Add total row
            tableRows.push(["", "", "TOTALE VALORE", currency + " " + totalValue.toFixed(2)]);

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 40,
                theme: 'striped',
                headStyles: { fillColor: [45, 55, 72] },
                didParseCell: function (data) {
                    if (data.row.index === tableRows.length - 1) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fillColor = [240, 240, 240];
                    }
                }
            });

            doc.text("Valore Totale Inventario: ‚Ç¨ " + totalValue.toFixed(2), 14, doc.lastAutoTable.finalY + 10);

            doc.save("report_valore.pdf");
            showNotification('PDF scaricato!', 'success');
        }

        // FUNZIONI IMPOSTAZIONI
        function toggleAutoSync() {
            const checkbox = document.getElementById('autoSyncEnabled');
            appData.settings.autoSync = checkbox.checked;
            saveToCloud();

            if (checkbox.checked) {
                showNotification('Sincronizzazione automatica attivata', 'success');
                updateCloudStatus('online', 'Auto-sync ON');
            } else {
                showNotification('Sincronizzazione automatica disattivata', 'warning');
                updateCloudStatus('offline', 'Locale');
            }
        }

        function generateQRCode() {
            const url = document.getElementById('googleScriptUrl').value;
            if (!url) {
                showNotification('Inserisci prima l\'URL dello script', 'error');
                return;
            }

            const container = document.getElementById('qrCodeContainer');
            const qrImage = document.getElementById('qrCodeImage');

            // Usa un servizio API per generare il QR code
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(url)}`;
            qrImage.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="max-width: 250px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">`;
            container.style.display = 'block';

            showNotification('QR Code generato!', 'success');
        }

        function saveSettings() {
            try {
                const notifications = document.getElementById('lowStockNotifications');
                const threshold = document.getElementById('lowStockThreshold');
                const lang = document.getElementById('language');
                const curr = document.getElementById('currency');
                const decimals = document.getElementById('decimalPlaces');
                const url = document.getElementById('googleScriptUrl');

                if (notifications) appData.settings.stockNotifications = notifications.value;
                if (threshold) appData.settings.lowStockLimit = parseInt(threshold.value) || 5;
                if (lang) appData.settings.language = lang.value;
                if (curr) appData.settings.currency = curr.value;
                if (decimals) appData.settings.decimalPlaces = parseInt(decimals.value) || 2;
                if (url) appData.settings.googleScriptUrl = url.value.trim();

                saveToCloud();
                showNotification('Impostazioni salvate!');
            } catch (err) {
                console.error('Errore durante il salvataggio:', err);
                showNotification('Errore nel salvataggio impostazioni', 'error');
            }
        }

        function exportBackup() {
            const dataStr = JSON.stringify(appData);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportFileDefaultName = 'inventario_backup.json';

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            showNotification('Backup esportato!');
        }

        function showImportBackupModal() {
            document.getElementById('importBackupModal').classList.add('show');
        }

        function closeImportBackupModal() {
            document.getElementById('importBackupModal').classList.remove('show');
        }

        function restoreBackup() {
            const fileInput = document.getElementById('backupFile');
            if (!fileInput.files.length) {
                showNotification('Seleziona un file di backup', 'error');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const backupData = JSON.parse(e.target.result);

                    // Validazione base dei dati
                    if (backupData.products && backupData.categories && backupData.suppliers) {
                        appData = backupData;
                        saveToCloud();
                        updateAll();
                        closeImportBackupModal();
                        showNotification('Backup ripristinato!');
                    } else {
                        showNotification('File di backup non valido', 'error');
                    }
                } catch (error) {
                    showNotification('Errore durante il ripristino del backup', 'error');
                }
            };

            reader.readAsText(file);
        }

        function resetData() {
            if (confirm('Sei sicuro di voler resettare tutti i dati? Questa operazione non pu√≤ essere annullata.')) {
                appData.products = [];
                appData.categories = [];
                appData.suppliers = [];
                saveToCloud();
                updateAll();
                showNotification('Dati resettati');
            }
        }

        // FUNZIONI IMPORT/EXPORT
        function showImportModal() {
            document.getElementById('importModal').classList.add('show');
            document.getElementById('excelFile').value = '';
            document.getElementById('importPreview').style.display = 'none';
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('show');
        }

        document.getElementById('excelFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    showImportPreview(jsonData);
                } catch (error) {
                    showNotification('Errore lettura file', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function showImportPreview(data) {
            const previewBody = document.getElementById('importPreviewBody');
            previewBody.innerHTML = '';
            data.slice(0, 5).forEach(row => {
                previewBody.innerHTML += `<tr>
                    <td>${row.Categoria || ''}</td><td>${row.Sottocategoria || ''}</td><td>${row.Prodotto || ''}</td>
                    <td>${row.Quantit√† || ''}</td><td>${row.Unit√† || ''}</td><td>${row.Fornitore || ''}</td><td>${row['Prezzo unitario'] || ''}</td>
                </tr>`;
            });
            document.getElementById('importPreview').style.display = 'block';
        }

        function processExcelImport() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) {
                showNotification('Seleziona un file', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    let importedCount = 0;
                    jsonData.forEach(row => {
                        if (row.Categoria && row.Prodotto) {
                            // Crea la categoria se non esiste
                            let category = appData.categories.find(c => c.name === row.Categoria);
                            if (!category) {
                                category = {
                                    id: Date.now() + importedCount,
                                    name: row.Categoria,
                                    productCount: 0,
                                    subcategories: row.Sottocategoria ? [row.Sottocategoria] : []
                                };
                                appData.categories.push(category);
                            } else if (row.Sottocategoria && !category.subcategories.includes(row.Sottocategoria)) {
                                category.subcategories.push(row.Sottocategoria);
                            }

                            // Crea il fornitore se non esiste
                            let supplier = appData.suppliers.find(s => s.name === row.Fornitore);
                            if (row.Fornitore && !supplier) {
                                supplier = {
                                    id: Date.now() + importedCount + 1000,
                                    name: row.Fornitore,
                                    phone: '',
                                    email: '',
                                    productCount: 0
                                };
                                appData.suppliers.push(supplier);
                            }

                            let dept = 'entrambi';
                            if (row.Reparto) {
                                const r = row.Reparto.toLowerCase();
                                if (r.includes('cucina')) dept = 'cucina';
                                else if (r.includes('bar')) dept = 'bar';
                            }

                            const newProduct = {
                                id: Date.now() + importedCount,
                                name: row.Prodotto,
                                category: row.Categoria,
                                subcategory: row.Sottocategoria || '',
                                department: dept,
                                quantity: parseFloat(row.Quantit√†) || 0,
                                unit: row.Unit√† || 'pezzi',
                                price: parseFloat(row['Prezzo unitario']) || 0,
                                supplier: row.Fornitore || 'Importato',
                                status: 'in-stock'
                            };
                            appData.products.push(newProduct);
                            category.productCount++;
                            if (supplier) supplier.productCount++;
                            importedCount++;
                        }
                    });

                    updateAllDropdowns();
                    saveToCloud();
                    updateAll();
                    closeImportModal();
                    showNotification(`${importedCount} prodotti importati!`);
                } catch (error) {
                    showNotification('Errore importazione', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }


        // FUNZIONI GRAFICI
        let catChartInstance = null;
        let stockChartInstance = null;

        function renderCharts() {
            renderCategoryChart();
            renderStockChart();
        }

        function renderCategoryChart() {
            const ctx = document.getElementById('categoryChartCanvas');
            if (!ctx) return;

            const currency = appData.settings.currency === 'EUR' ? '‚Ç¨' : '$';

            // Prepare data: Value per Category
            const labels = appData.categories.map(c => c.name);
            const data = appData.categories.map(c => {
                return appData.products
                    .filter(p => p.category === c.name)
                    .reduce((sum, p) => sum + (p.quantity * p.price), 0);
            });

            if (catChartInstance) catChartInstance.destroy();

            Chart.register(ChartDataLabels);

            catChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valore per Categoria',
                        data: data,
                        backgroundColor: [
                            '#4361ee', '#3a0ca3', '#7209b7', '#f72585', '#4cc9f0',
                            '#fb8500', '#ffb703', '#8338ec', '#ff006e'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.label || '';
                                    if (label) { label += ': '; }
                                    let value = context.parsed;
                                    let total = context.chart._metasets[context.datasetIndex].total;
                                    let percentage = (value / total * 100).toFixed(1) + '%';
                                    return label + currency + ' ' + value.toLocaleString('it-IT', { minimumFractionDigits: 2 }) + ' (' + percentage + ')';
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 12 },
                            formatter: (value, ctx) => {
                                let sum = 0;
                                let dataArr = ctx.chart.data.datasets[0].data;
                                dataArr.map(data => { sum += data; });
                                let percentage = (value * 100 / sum).toFixed(1) + "%";
                                return percentage;
                            },
                            anchor: 'center',
                            align: 'center',
                            display: function (context) {
                                return context.dataset.data[context.dataIndex] > 0; // Hide 0% labels
                            }
                        }
                    }
                }
            });
        }

        function renderStockChart() {
            const ctx = document.getElementById('stockChartCanvas');
            if (!ctx) return;

            const lowStock = appData.products.filter(p => p.quantity <= appData.settings.lowStockLimit && p.quantity > 0).length;
            const outOfStock = appData.products.filter(p => p.quantity === 0).length;
            const inStock = appData.products.filter(p => p.quantity > appData.settings.lowStockLimit).length;

            if (stockChartInstance) stockChartInstance.destroy();

            stockChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['In Stock', 'Stock Basso', 'Esaurito'],
                    datasets: [{
                        label: 'Stato Stock',
                        data: [inStock, lowStock, outOfStock],
                        backgroundColor: ['#4cc9f0', '#f72585', '#e63946'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function updateAllDropdowns() {
            populateCategoryDropdown('productCategory');
            populateCategoryDropdown('modalProductCategory');
            populateSupplierDropdown('productSupplier');
            populateSupplierDropdown('modalProductSupplier');
        }

        function exportToExcel() {
            try {
                const data = appData.products.map(product => ({
                    'Prodotto': product.name,
                    'Reparto': (product.department || 'entrambi').charAt(0).toUpperCase() + (product.department || 'entrambi').slice(1),
                    'Categoria': product.category,
                    'Sottocategoria': product.subcategory,
                    'Quantit√†': product.quantity,
                    'Unit√†': product.unit,
                    'Fornitore': product.supplier,
                    'Prezzo unitario': product.price,
                    'Valore totale': (product.quantity * product.price).toFixed(2)
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Inventario");
                XLSX.writeFile(wb, "Inventario.xlsx");
                showNotification('Esportazione completata!');
            } catch (error) {
                showNotification('Errore esportazione', 'error');
            }
        }

        // MONTHLY INVENTORY FUNCTIONS

        function setDepartmentFilter(department) {
            appData.settings.selectedDepartment = department;
            saveToCloud();

            // Update UI
            document.querySelectorAll('.department-btn').forEach(btn => {
                btn.classList.toggle('active', btn.id === `dept-btn-${department}`);
            });

            renderMonthlyInventoryTable();
        }

        function getDepartmentIcon(department) {
            switch (department) {
                case 'cucina': return 'üç≥ Cucina';
                case 'bar': return 'üçπ Bar';
                default: return 'üè¢ Entrambi';
            }
        }

        function getDepartmentBadgeClass(department) {
            switch (department) {
                case 'cucina': return 'badge-cucina';
                case 'bar': return 'badge-bar';
                default: return 'badge-entrambi';
            }
        }

        function renderMonthlyInventoryTable() {
            const tbody = document.getElementById('monthlyInventoryTableBody');
            if (!tbody) return;

            const searchTerm = document.getElementById('monthlySearchInput')?.value.toLowerCase() || '';
            const selectedDept = appData.settings.selectedDepartment || 'tutti';

            // Update department buttons state on load
            document.querySelectorAll('.department-btn').forEach(btn => {
                btn.classList.toggle('active', btn.id === `dept-btn-${selectedDept}`);
            });

            const filteredProducts = appData.products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                    product.category.toLowerCase().includes(searchTerm) ||
                    (product.supplier && product.supplier.toLowerCase().includes(searchTerm));

                const productDept = product.department || 'entrambi';
                const matchesDept = selectedDept === 'tutti' ||
                    productDept === 'entrambi' ||
                    productDept === selectedDept;

                return matchesSearch && matchesDept;
            });

            tbody.innerHTML = filteredProducts.map(p => {
                const isChanged = appData.monthlyInventoryChanges[p.id];
                const rowClass = isChanged ? 'style="background: #e6f7ff;"' : '';
                const dept = p.department || 'entrambi';

                return `
                <tr ${rowClass}>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <strong>${p.name}</strong>
                            ${isChanged ? '<i class="fas fa-check-circle" style="color: var(--success); font-size: 0.9rem;" title="Modificato"></i>' : ''}
                        </div>
                    </td>
                    <td><span class="badge ${getDepartmentBadgeClass(dept)}">${getDepartmentIcon(dept)}</span></td>
                    <td><span class="badge badge-neutral">${p.category}</span></td>
                    <td>${p.supplier || '-'}</td>
                    <td>
                        <span style="font-weight: 600; color: var(--gray);">${p.quantity} ${p.unit}</span>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <button class="btn-action" onclick="incrementQuantity(${p.id}, -1)" title="Decrementa">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" 
                                id="monthly-qty-${p.id}" 
                                value="${p.quantity}" 
                                min="0" 
                                step="0.001"
                                onchange="updateMonthlyQuantity(${p.id}, this.value)"
                                style="width: 100px; padding: 0.5rem; border: 2px solid var(--primary); border-radius: 8px; text-align: center; font-weight: 600; font-size: 1rem;"
                            />
                            <button class="btn-action" onclick="incrementQuantity(${p.id}, 1)" title="Incrementa">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="openQuickQuantityModal(${p.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');

            updateMonthlyStats(filteredProducts.length);
        }

        function updateMonthlyQuantity(productId, newQuantity) {
            const qty = parseFloat(newQuantity);
            if (isNaN(qty) || qty < 0) {
                showNotification('Quantit√† non valida', 'error');
                renderMonthlyInventoryTable();
                return;
            }

            const productIndex = appData.products.findIndex(p => p.id === productId);
            if (productIndex === -1) return;

            appData.products[productIndex].quantity = qty;
            appData.products[productIndex].status =
                qty === 0 ? 'out-of-stock' :
                    qty <= appData.settings.lowStockLimit ? 'low-stock' : 'in-stock';

            // Mark as changed
            appData.monthlyInventoryChanges[productId] = true;

            saveToCloud();
            updateAll();
            renderMonthlyInventoryTable();
        }

        function incrementQuantity(productId, amount) {
            const product = appData.products.find(p => p.id === productId);
            if (!product) return;

            const newQty = Math.max(0, product.quantity + amount);
            updateMonthlyQuantity(productId, newQty);
        }

        function filterMonthlyInventory() {
            renderMonthlyInventoryTable();
        }

        function updateMonthlyStats(totalFiltered = null) {
            // Count changes only for filtered products if totalFiltered is provided
            // Otherwise use total changes
            const countedProducts = Object.keys(appData.monthlyInventoryChanges).filter(id => {
                // Determine if this changed product is currently visible (matches filter)
                // This is an approximation since we don't have the filtered list here without passing it
                // Ideally, we pass the filtered list length.
                return true;
            }).length;

            // To be more precise, let's just count how many of the currently filtered products are changed
            // But for now, let's stick to total verified count vs total filtered list

            const totalProducts = totalFiltered !== null ? totalFiltered : appData.products.length;

            // Recalculate counted for the current view
            // We need to know which products are in the view to count them accurately as "verified in this view"
            // But simpler is: "Verified (Total)" and "Remaining (Total)"
            // OR "Verified (View)" and "Remaining (View)"

            // Let's go with View based statistics since we are filtering
            let viewCounted = 0;
            if (totalFiltered !== null) {
                // We need to re-filter to check which ones are changed
                // This is expensive to do again. 
                // Let's assume passed totalFiltered is the denominator.
                // The numerator should be how many of THESE products present in table are changed.
                // Since we don't have the list, let's look at the DOM or re-filter.
                // Let's re-filter for stats correctness.
                const searchTerm = document.getElementById('monthlySearchInput')?.value.toLowerCase() || '';
                const selectedDept = appData.settings.selectedDepartment || 'tutti';

                const currentViewProducts = appData.products.filter(product => {
                    const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                        product.category.toLowerCase().includes(searchTerm) ||
                        (product.supplier && product.supplier.toLowerCase().includes(searchTerm));

                    const productDept = product.department || 'entrambi';
                    const matchesDept = selectedDept === 'tutti' ||
                        productDept === 'entrambi' ||
                        productDept === selectedDept;

                    return matchesSearch && matchesDept;
                });

                viewCounted = currentViewProducts.filter(p => appData.monthlyInventoryChanges[p.id]).length;
                document.getElementById('monthlyCountedProducts').textContent = viewCounted;
                document.getElementById('monthlyRemainingProducts').textContent = totalFiltered - viewCounted;

            } else {
                const counted = Object.keys(appData.monthlyInventoryChanges).length;
                const total = appData.products.length;
                document.getElementById('monthlyCountedProducts').textContent = counted;
                document.getElementById('monthlyRemainingProducts').textContent = total - counted;
            }

            // Update last snapshot date
            if (appData.monthlySnapshots && appData.monthlySnapshots.length > 0) {
                const lastSnapshot = appData.monthlySnapshots[appData.monthlySnapshots.length - 1];
                const date = new Date(lastSnapshot.date);
                document.getElementById('lastSnapshotDate').textContent = date.toLocaleDateString('it-IT');
            } else {
                document.getElementById('lastSnapshotDate').textContent = 'Mai';
            }
        }

        function createMonthlySnapshot() {
            const now = new Date();
            const snapshot = {
                id: Date.now(),
                date: now.toISOString(),
                products: appData.products.map(p => ({
                    id: p.id,
                    name: p.name,
                    category: p.category,
                    subcategory: p.subcategory,
                    quantity: p.quantity,
                    unit: p.unit,
                    price: p.price,
                    supplier: p.supplier
                })),
                totalValue: appData.products.reduce((sum, p) => sum + (p.quantity * p.price), 0),
                totalProducts: appData.products.length
            };

            if (!appData.monthlySnapshots) {
                appData.monthlySnapshots = [];
            }

            appData.monthlySnapshots.push(snapshot);
            saveToCloud();

            showNotification(`Snapshot salvato: ${now.toLocaleDateString('it-IT')} ${now.toLocaleTimeString('it-IT')}`, 'success');
            updateMonthlyStats();
        }

        function exportMonthlyToExcel() {
            try {
                const now = new Date();
                const dateStr = now.toLocaleDateString('it-IT').replace(/\//g, '-');

                const data = appData.products.map(product => ({
                    'Data Inventario': dateStr,
                    'Prodotto': product.name,
                    'Reparto': (product.department || 'entrambi').charAt(0).toUpperCase() + (product.department || 'entrambi').slice(1),
                    'Categoria': product.category,
                    'Sottocategoria': product.subcategory,
                    'Quantit√†': product.quantity,
                    'Unit√†': product.unit,
                    'Fornitore': product.supplier,
                    'Prezzo Unitario': product.price,
                    'Valore Totale': (product.quantity * product.price).toFixed(2)
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, `Inventario ${dateStr}`);
                XLSX.writeFile(wb, `Inventario_Mensile_${dateStr}.xlsx`);

                showNotification('Inventario mensile esportato!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Errore durante l\'esportazione', 'error');
            }
        }

        // Snapshots Modal Functions
        function showSnapshotsModal() {
            renderSnapshotsList();
            document.getElementById('snapshotsModal').classList.add('show');
        }

        function closeSnapshotsModal() {
            document.getElementById('snapshotsModal').classList.remove('show');
        }

        function renderSnapshotsList() {
            const container = document.getElementById('snapshotsListContainer');
            if (!container) return;

            if (!appData.monthlySnapshots || appData.monthlySnapshots.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: var(--gray); padding: 2rem;">
                        <i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.3; display: block; margin-bottom: 1rem;"></i>
                        Nessuno snapshot salvato
                    </p>`;
                return;
            }

            const currency = appData.settings.currency === 'EUR' ? '‚Ç¨' : '$';
            container.innerHTML = appData.monthlySnapshots.slice().reverse().map(snapshot => {
                const date = new Date(snapshot.date);
                return `
                    <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--primary);">
                                    <i class="fas fa-calendar-alt"></i>
                                    ${date.toLocaleDateString('it-IT')} - ${date.toLocaleTimeString('it-IT')}
                                </h4>
                                <p style="margin: 0; color: var(--gray); font-size: 0.9rem;">
                                    ${snapshot.totalProducts} prodotti ‚Ä¢ Valore: ${currency} ${snapshot.totalValue.toLocaleString('it-IT', { minimumFractionDigits: 2 })}
                                </p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-sm btn-outline" onclick="exportSnapshot(${snapshot.id})">
                                    <i class="fas fa-download"></i> Esporta
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSnapshot(${snapshot.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        function exportSnapshot(snapshotId) {
            const snapshot = appData.monthlySnapshots.find(s => s.id === snapshotId);
            if (!snapshot) return;

            try {
                const date = new Date(snapshot.date);
                const dateStr = date.toLocaleDateString('it-IT').replace(/\//g, '-');

                const data = snapshot.products.map(product => ({
                    'Data Snapshot': dateStr,
                    'Prodotto': product.name,
                    'Reparto': (product.department || 'entrambi').charAt(0).toUpperCase() + (product.department || 'entrambi').slice(1),
                    'Categoria': product.category,
                    'Sottocategoria': product.subcategory,
                    'Quantit√†': product.quantity,
                    'Unit√†': product.unit,
                    'Fornitore': product.supplier,
                    'Prezzo Unitario': product.price,
                    'Valore Totale': (product.quantity * product.price).toFixed(2)
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, `Snapshot ${dateStr}`);
                XLSX.writeFile(wb, `Snapshot_${dateStr}.xlsx`);

                showNotification('Snapshot esportato!', 'success');
            } catch (error) {
                showNotification('Errore durante l\'esportazione', 'error');
            }
        }

        function deleteSnapshot(snapshotId) {
            if (!confirm('Eliminare questo snapshot?')) return;

            const index = appData.monthlySnapshots.findIndex(s => s.id === snapshotId);
            if (index !== -1) {
                appData.monthlySnapshots.splice(index, 1);
                saveToCloud();
                renderSnapshotsList();
                updateMonthlyStats();
                showNotification('Snapshot eliminato', 'success');
            }
        }

        // Reset Quantities Modal Functions
        function showResetQuantitiesModal() {
            document.getElementById('confirmResetCheckbox').checked = false;
            document.getElementById('confirmResetBtn').disabled = true;
            document.getElementById('resetQuantitiesModal').classList.add('show');
        }

        function closeResetQuantitiesModal() {
            document.getElementById('resetQuantitiesModal').classList.remove('show');
        }

        // Enable/disable reset button based on checkbox
        document.addEventListener('DOMContentLoaded', function () {
            const checkbox = document.getElementById('confirmResetCheckbox');
            const btn = document.getElementById('confirmResetBtn');
            if (checkbox && btn) {
                checkbox.addEventListener('change', function () {
                    btn.disabled = !this.checked;
                });
            }
        });

        function confirmResetQuantities() {
            // Create automatic snapshot before reset
            createMonthlySnapshot();

            // Reset all quantities to 0
            appData.products.forEach(product => {
                product.quantity = 0;
                product.status = 'out-of-stock';
            });

            // Clear monthly changes tracking
            appData.monthlyInventoryChanges = {};

            saveToCloud();
            updateAll();
            renderMonthlyInventoryTable();
            closeResetQuantitiesModal();

            showNotification('Quantit√† azzerate! Snapshot salvato automaticamente.', 'success');
        }

        // UTILITY
        // UTILITIES & PERFORMANCE
        let searchTimeout;
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const filteredProducts = appData.products.filter(product =>
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.category.toLowerCase().includes(searchTerm) ||
                    product.subcategory.toLowerCase().includes(searchTerm)
                );

                const tbody = document.getElementById('productsTableBody');
                if (!tbody) return;

                tbody.innerHTML = filteredProducts.slice(0, 10).map(p => createProductRow(p)).join('');

                // If on products tab, also filter the main table
                const allTbody = document.getElementById('allProductsTableBody');
                if (allTbody && document.getElementById('products-tab').classList.contains('active')) {
                    allTbody.innerHTML = filteredProducts.map(p => {
                        const currency = appData.settings.currency === 'EUR' ? '‚Ç¨' : '$';
                        return `
                        <tr class="fade-in">
                            <td class="product-cell">
                                <span class="product-name" style="font-weight: 600; color: var(--dark);">${p.name}</span>
                            </td>
                            <td><span class="product-meta">${p.supplier || 'Nessun fornitore'}</span></td>
                            <td><span class="badge badge-category">${p.category}</span></td>
                            <td><span class="subcategory-text">${p.subcategory || '-'}</span></td>
                            <td class="quantity-cell">
                                <span class="quantity-value">${p.quantity}</span>
                                <span class="quantity-unit">${p.unit}</span>
                            </td>
                            <td class="price-cell">${currency} ${p.price.toFixed(2)}</td>
                            <td>
                                <div class="table-actions">
                                    <button class="action-btn edit" onclick="editProduct(${p.id})" title="Modifica"><i class="fas fa-edit"></i></button>
                                    <button class="action-btn delete" onclick="deleteProduct(${p.id})" title="Elimina"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </td>
                        </tr>`;
                    }).join('');
                }
            }, 300);
        }

        function refreshData() {
            updateAll();
            showNotification('Sincronizzazione completata!', 'success');
        }

        function updateAll() {
            updateStatistics();
            renderRecentProducts();
            renderAllProductsTable();
            renderCategoriesTable();
            renderSuppliersTable();
            updateAllDropdowns();
            renderMonthlyInventoryTable(); // Update monthly inventory table
            saveToCloud(); // Auto-save to localStorage
        }

        function saveToCloud() {
            localStorage.setItem('inventarioData', JSON.stringify(appData));

            // Auto-Sync to Google Sheets
            if (appData.settings.autoSync && appData.settings.googleScriptUrl) {
                debounceAutoSync();
            }
        }

        let autoSyncTimeout;
        function debounceAutoSync() {
            updateCloudStatus('syncing', 'In coda...');
            clearTimeout(autoSyncTimeout);
            autoSyncTimeout = setTimeout(() => {
                syncToGoogle(true); // true per modalit√† silenziosa
            }, 3000); // Aspetta 3 secondi di inattivit√†
        }

        function updateCloudStatus(status, message) {
            const statusEl = document.getElementById('cloudStatus');
            const textEl = document.getElementById('cloudStatusText');
            if (!statusEl || !textEl) return;

            statusEl.className = 'sync-status ' + status;
            textEl.textContent = message || (status === 'online' ? 'Sincronizzato' : status === 'offline' ? 'Locale' : 'In corso...');

            const icon = statusEl.querySelector('i');
            if (status === 'syncing') {
                icon.className = 'fas fa-sync fa-spin';
            } else if (status === 'error') {
                icon.className = 'fas fa-exclamation-triangle';
            } else {
                icon.className = 'fas fa-cloud';
            }
        }
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const title = document.getElementById('notificationTitle');
            const msg = document.getElementById('notificationMessage');
            title.textContent = type === 'success' ? 'Successo' : type === 'error' ? 'Errore' : 'Avviso';
            msg.textContent = message;
            notification.className = 'notification ' + type;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }


        // GOOGLE SHEETS INTEGRATION
        function syncToGoogle(silent = false) {
            // Forza aggiornamento URL
            const urlInput = document.getElementById('googleScriptUrl');
            if (urlInput && urlInput.value) {
                appData.settings.googleScriptUrl = urlInput.value.trim();
                localStorage.setItem('inventarioData', JSON.stringify(appData));
            }

            const url = appData.settings.googleScriptUrl;
            if (!url || !url.startsWith('https://script.google.com')) {
                if (!silent) {
                    showNotification('URL Script non valido. Incolla l\'indirizzo corretto nelle Impostazioni.', 'error');
                    updateCloudStatus('error', 'URL mancante');
                }
                return;
            }

            if (!silent) {
                showNotification('Invio dati in corso...', 'warning');
            }
            updateCloudStatus('syncing', 'Sincronizzazione...');

            try {
                // Use fetch instead of form submit to avoid opening new tabs
                fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'data=' + encodeURIComponent(JSON.stringify(appData))
                }).then(() => {
                    if (!silent) {
                        showNotification('Dati inviati a Google Sheets!', 'success');
                    }
                    updateCloudStatus('online', 'Sincronizzato');
                }).catch(e => {
                    // no-cors mode doesn't return errors, so this is fine
                    if (!silent) {
                        showNotification('Dati inviati a Google Sheets!', 'success');
                    }
                    updateCloudStatus('online', 'Sincronizzato');
                });
            } catch (e) {
                if (!silent) {
                    showNotification('Errore di invio: ' + e.message, 'error');
                }
                updateCloudStatus('error', 'Errore sync');
            }
        }

        function restoreFromGoogle(silent = false) {
            const url = appData.settings.googleScriptUrl;
            if (!url) {
                if (!silent) {
                    showNotification('Inserisci prima l\'URL dello script nelle impostazioni', 'error');
                    updateCloudStatus('error', 'URL mancante');
                }
                return;
            }

            if (!silent && !confirm('Questo sovrascriver√† i dati locali con quelli presenti su Google Sheets. Continuare?')) return;

            if (!silent) {
                showNotification('Scaricamento dati...', 'warning');
            }
            updateCloudStatus('syncing', 'Caricamento...');

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.products) {
                        appData = data;
                        // Mantieni autoSync attivo
                        if (appData.settings.autoSync === undefined) {
                            appData.settings.autoSync = true;
                        }
                        localStorage.setItem('inventarioData', JSON.stringify(appData));
                        updateAll();
                        // Update settings inputs 
                        loadSettingsTab();
                        if (!silent) {
                            showNotification('Dati ripristinati da Google!', 'success');
                        }
                        updateCloudStatus('online', 'Sincronizzato');
                    } else {
                        if (!silent) {
                            showNotification('Dati non validi ricevuti da Google', 'error');
                        }
                        updateCloudStatus('error', 'Dati non validi');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (!silent) {
                        showNotification('Errore durante il ripristino: ' + error.message, 'error');
                    }
                    updateCloudStatus('offline', 'Locale');
                });
        }

        // INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', function () {
            const savedData = localStorage.getItem('inventarioData');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    appData.products = parsedData.products || appData.products;
                    appData.categories = parsedData.categories || appData.categories;
                    appData.suppliers = parsedData.suppliers || appData.suppliers;
                    appData.settings = parsedData.settings || appData.settings;

                    // Abilita auto-sync di default se non impostato
                    if (appData.settings.autoSync === undefined) {
                        appData.settings.autoSync = true;
                    }
                } catch (e) {
                    console.error('Errore nel caricamento dei dati salvati:', e);
                }
            }
            loadDashboardData();
            showNotification('Sistema caricato!');

            // Auto-restore da Google all'avvio (se configurato)
            if (appData.settings.googleScriptUrl && appData.settings.autoSync) {
                setTimeout(() => restoreFromGoogle(true), 1500);
            }

            // Registrazione Service Worker per PWA
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js')
                        .then(reg => console.log('Service Worker registrato!'))
                        .catch(err => console.log('Errore Service Worker:', err));
                });
            }
        });

        // EXCEL IMPORT FUNCTIONS
        function showImportModal() {
            const modal = document.getElementById('importModal');
            if (modal) {
                modal.classList.add('show');
                // Reset file input
                const fileInput = document.getElementById('excelFile');
                if (fileInput) fileInput.value = '';
                // Hide preview
                const preview = document.getElementById('importPreview');
                if (preview) preview.style.display = 'none';
            }
        }

        function closeImportModal() {
            const modal = document.getElementById('importModal');
            if (modal) modal.classList.remove('show');
        }

        // Handle Excel file selection and preview
        document.addEventListener('DOMContentLoaded', function () {
            const fileInput = document.getElementById('excelFile');
            if (fileInput) {
                fileInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                            // Show preview
                            displayImportPreview(jsonData);
                        } catch (error) {
                            showNotification('Errore nella lettura del file Excel: ' + error.message, 'error');
                        }
                    };
                    reader.readAsArrayBuffer(file);
                });
            }
        });

        function displayImportPreview(data) {
            const preview = document.getElementById('importPreview');
            const tbody = document.getElementById('importPreviewBody');

            if (!preview || !tbody) return;

            tbody.innerHTML = '';

            // Show first 10 rows as preview
            const previewData = data.slice(0, 10);
            previewData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.Categoria || ''}</td>
                    <td>${row.Sottocategoria || ''}</td>
                    <td>${row.Prodotto || ''}</td>
                    <td>${row.Quantit√† || row.Quantita || 0}</td>
                    <td>${row.Unit√† || row.Unita || ''}</td>
                    <td>${row.Fornitore || ''}</td>
                    <td>${row.Prezzo || 0}</td>
                    <td>${row.Reparto || 'entrambi'}</td>
                `;
                tbody.appendChild(tr);
            });

            preview.style.display = 'block';
        }

        function processExcelImport() {
            const fileInput = document.getElementById('excelFile');
            if (!fileInput || !fileInput.files[0]) {
                showNotification('Seleziona un file Excel prima di importare', 'error');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    let importedCount = 0;
                    let errorCount = 0;

                    jsonData.forEach(row => {
                        try {
                            // Validate required fields
                            if (!row.Prodotto || !row.Categoria || !row.Sottocategoria) {
                                errorCount++;
                                return;
                            }

                            // Get or create category
                            let category = appData.categories.find(c => c.name === row.Categoria);
                            if (!category) {
                                const newCategoryId = appData.categories.length > 0
                                    ? Math.max(...appData.categories.map(c => c.id)) + 1
                                    : 1;
                                category = {
                                    id: newCategoryId,
                                    name: row.Categoria,
                                    subcategories: [],
                                    productCount: 0
                                };
                                appData.categories.push(category);
                            }

                            // Add subcategory if not exists
                            if (row.Sottocategoria && !category.subcategories.includes(row.Sottocategoria)) {
                                category.subcategories.push(row.Sottocategoria);
                            }

                            // Get or create supplier
                            let supplier = null;
                            if (row.Fornitore) {
                                supplier = appData.suppliers.find(s => s.name === row.Fornitore);
                                if (!supplier) {
                                    const newSupplierId = appData.suppliers.length > 0
                                        ? Math.max(...appData.suppliers.map(s => s.id)) + 1
                                        : 1;
                                    supplier = {
                                        id: newSupplierId,
                                        name: row.Fornitore,
                                        phone: '',
                                        email: '',
                                        productCount: 0
                                    };
                                    appData.suppliers.push(supplier);
                                }
                            }

                            // Create product
                            const newProductId = appData.products.length > 0
                                ? Math.max(...appData.products.map(p => p.id)) + 1
                                : 1;

                            const quantity = parseFloat(row.Quantit√† || row.Quantita || 0);
                            const price = parseFloat(row.Prezzo || 0);
                            const unit = (row.Unit√† || row.Unita || 'pezzi').toLowerCase();
                            const department = (row.Reparto || 'entrambi').toLowerCase();

                            const newProduct = {
                                id: newProductId,
                                name: row.Prodotto,
                                category: row.Categoria,
                                subcategory: row.Sottocategoria,
                                quantity: quantity,
                                unit: unit,
                                price: price,
                                supplier: row.Fornitore || '',
                                department: department,
                                status: quantity > 5 ? 'in-stock' : quantity > 0 ? 'low-stock' : 'out-of-stock'
                            };

                            appData.products.push(newProduct);
                            category.productCount++;
                            if (supplier) supplier.productCount++;
                            importedCount++;

                        } catch (error) {
                            console.error('Error importing row:', error);
                            errorCount++;
                        }
                    });

                    // Save and update
                    saveData();
                    updateAll();
                    closeImportModal();

                    // Show result
                    if (importedCount > 0) {
                        showNotification(`Importati ${importedCount} prodotti con successo!${errorCount > 0 ? ` (${errorCount} errori)` : ''}`, 'success');
                    } else {
                        showNotification('Nessun prodotto importato. Verifica il formato del file.', 'error');
                    }

                } catch (error) {
                    showNotification('Errore durante l\'importazione: ' + error.message, 'error');
                    console.error('Import error:', error);
                }
            };

            reader.readAsArrayBuffer(file);
        }
    </script>
</body>

</html>